import { useState, useRef, useEffect, useCallback } from 'react';
import * as XLSX from 'xlsx';
import { supabase, toCamelCase, toSnakeCase } from './lib/supabase';

const defaultCustomers = [];
const defaultVisaApplications = [];
const defaultTours = [];
const defaultHotelReservations = [];
const defaultUsers = [{ id: 1, email: 'onder@paydostur.com', password: '123456', name: 'Ã–nder', role: 'admin' }];

const turkishProvinces = ['Adana', 'AdÄ±yaman', 'Afyonkarahisar', 'AÄŸrÄ±', 'Amasya', 'Ankara', 'Antalya', 'Artvin', 'AydÄ±n', 'BalÄ±kesir', 'Bilecik', 'BingÃ¶l', 'Bitlis', 'Bolu', 'Burdur', 'Bursa', 'Ã‡anakkale', 'Ã‡ankÄ±rÄ±', 'Ã‡orum', 'Denizli', 'DiyarbakÄ±r', 'Edirne', 'ElazÄ±ÄŸ', 'Erzincan', 'Erzurum', 'EskiÅŸehir', 'Gaziantep', 'Giresun', 'GÃ¼mÃ¼ÅŸhane', 'Hakkari', 'Hatay', 'Isparta', 'Mersin', 'Ä°stanbul', 'Ä°zmir', 'Kars', 'Kastamonu', 'Kayseri', 'KÄ±rklareli', 'KÄ±rÅŸehir', 'Kocaeli', 'Konya', 'KÃ¼tahya', 'Malatya', 'Manisa', 'KahramanmaraÅŸ', 'Mardin', 'MuÄŸla', 'MuÅŸ', 'NevÅŸehir', 'NiÄŸde', 'Ordu', 'Rize', 'Sakarya', 'Samsun', 'Siirt', 'Sinop', 'Sivas', 'TekirdaÄŸ', 'Tokat', 'Trabzon', 'Tunceli', 'ÅanlÄ±urfa', 'UÅŸak', 'Van', 'Yozgat', 'Zonguldak', 'Aksaray', 'Bayburt', 'Karaman', 'KÄ±rÄ±kkale', 'Batman', 'ÅÄ±rnak', 'BartÄ±n', 'Ardahan', 'IÄŸdÄ±r', 'Yalova', 'KarabÃ¼k', 'Kilis', 'Osmaniye', 'DÃ¼zce'];
const schengenCountries = ['Almanya', 'Avusturya', 'BelÃ§ika', 'Ã‡ekya', 'Danimarka', 'Estonya', 'Finlandiya', 'Fransa', 'HÄ±rvatistan', 'Hollanda', 'Ä°spanya', 'Ä°sveÃ§', 'Ä°sviÃ§re', 'Ä°talya', 'Ä°zlanda', 'Letonya', 'Liechtenstein', 'Litvanya', 'LÃ¼ksemburg', 'Macaristan', 'Malta', 'NorveÃ§', 'Polonya', 'Portekiz', 'Slovakya', 'Slovenya', 'Yunanistan'];
const visaStatuses = ['Evrak Topluyor', 'Evrak TamamlandÄ±', 'Evraklar GÃ¶nderildi', 'E-posta GÃ¶nderildi', 'Randevu Bekliyor', 'BaÅŸvuru YapÄ±ldÄ±', 'SonuÃ§ Bekliyor', 'MÃ¼ÅŸteri Ä°ptal Etti'];
const tourStatuses = ['Planlama', 'AÃ§Ä±k', 'Dolu', 'Devam Ediyor', 'TamamlandÄ±', 'Ä°ptal'];
const hotelStatuses = ['Beklemede', 'OnaylandÄ±', 'Ä°ptal', 'TamamlandÄ±'];
const roomTypes = ['Standard', 'Superior', 'Deluxe', 'Suite', 'Family', 'King', 'Twin'];

const labelStyle = { display: 'block', fontSize: '12px', color: '#94a3b8', marginBottom: '6px', fontWeight: '500' };
const inputStyle = { width: '100%', padding: '10px 12px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.15)', borderRadius: '8px', color: '#e8f1f8', fontSize: '14px', outline: 'none', boxSizing: 'border-box' };
const selectStyle = { width: '100%', padding: '10px 12px', background: '#0f2744', border: '1px solid rgba(255,255,255,0.15)', borderRadius: '8px', color: '#e8f1f8', fontSize: '14px', outline: 'none', boxSizing: 'border-box' };
const dateSelectStyle = { padding: '10px 6px', background: '#0f2744', border: '1px solid rgba(255,255,255,0.15)', borderRadius: '8px', color: '#e8f1f8', fontSize: '13px', outline: 'none' };

const isValidEmail = (e) => !e || /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e);
const formatDate = (d) => { if (!d) return '-'; if (typeof d !== 'string') d = String(d); if (d.includes('-')) return d.split('-').reverse().join('.'); if (d.includes('.')) return d; return d; };
const safeParseTags = (val) => { if (!val) return []; if (Array.isArray(val)) return val.filter(t => t && typeof t === 'string'); if (typeof val === 'string') return val.split(',').map(t => t.trim()).filter(Boolean); return []; };
const safeParseActivities = (val) => { if (!val) return []; if (Array.isArray(val)) return val; if (typeof val === 'string') { try { const parsed = JSON.parse(val); return Array.isArray(parsed) ? parsed : []; } catch { return []; } } return []; };
const safeParseDate = (dateStr) => { if (!dateStr || typeof dateStr !== 'string') return null; const parts = dateStr.split('-'); if (parts.length !== 3) return null; const [year, month, day] = parts.map(Number); if (isNaN(year) || isNaN(month) || isNaN(day)) return null; const date = new Date(year, month - 1, day, 12, 0, 0); if (date.getFullYear() !== year || date.getMonth() !== month - 1 || date.getDate() !== day) return null; return date; };
const safeParseNumber = (val) => { if (!val) return 0; const cleaned = String(val).replace(/[â‚¬$Â£â‚º\s]/g, '').replace(',', '.'); const num = parseFloat(cleaned); return isNaN(num) ? 0 : num; };
const getDaysLeft = (dateStr) => { const date = safeParseDate(dateStr); if (!date) return null; const today = new Date(); today.setHours(0, 0, 0, 0); date.setHours(0, 0, 0, 0); return Math.ceil((date - today) / (1000 * 60 * 60 * 24)); };
const generateUniqueId = () => Date.now() + Math.random();

function DateInput({ label, value, onChange }) {
  const parseDate = (dateStr) => { if (!dateStr || typeof dateStr !== 'string') return { day: '', month: '', year: '' }; const parts = dateStr.split('-'); if (parts.length !== 3) return { day: '', month: '', year: '' }; return { year: parts[0] || '', month: parts[1] || '', day: parts[2] || '' }; };
  const [day, setDay] = useState(''); const [month, setMonth] = useState(''); const [year, setYear] = useState('');
  useEffect(() => { const parsed = parseDate(value); setDay(parsed.day); setMonth(parsed.month); setYear(parsed.year); }, [value]);
  const getDaysInMonth = (m, y) => { if (!m) return 31; const monthNum = parseInt(m); const yearNum = parseInt(y) || new Date().getFullYear(); if ([4, 6, 9, 11].includes(monthNum)) return 30; if (monthNum === 2) { const isLeap = (yearNum % 4 === 0 && yearNum % 100 !== 0) || (yearNum % 400 === 0); return isLeap ? 29 : 28; } return 31; };
  const maxDays = getDaysInMonth(month, year); const days = Array.from({ length: maxDays }, (_, i) => String(i + 1).padStart(2, '0'));
  const buildDate = (d, m, y) => { if (!d || !m || !y) return; const maxD = getDaysInMonth(m, y); const validDay = Math.min(parseInt(d), maxD); const dateStr = `${y}-${m}-${String(validDay).padStart(2, '0')}`; const testDate = new Date(y, parseInt(m) - 1, validDay); if (isNaN(testDate.getTime())) return; onChange(dateStr); };
  const handleDayChange = (newDay) => { setDay(newDay); buildDate(newDay, month, year); };
  const handleMonthChange = (newMonth) => { setMonth(newMonth); const maxD = getDaysInMonth(newMonth, year); const validDay = day && parseInt(day) > maxD ? String(maxD).padStart(2, '0') : day; if (validDay !== day) setDay(validDay); buildDate(validDay, newMonth, year); };
  const handleYearChange = (newYear) => { setYear(newYear); const maxD = getDaysInMonth(month, newYear); const validDay = day && parseInt(day) > maxD ? String(maxD).padStart(2, '0') : day; if (validDay !== day) setDay(validDay); buildDate(validDay, month, newYear); };
  const months = [{v:'01',l:'Ocak'},{v:'02',l:'Åubat'},{v:'03',l:'Mart'},{v:'04',l:'Nisan'},{v:'05',l:'MayÄ±s'},{v:'06',l:'Haziran'},{v:'07',l:'Temmuz'},{v:'08',l:'AÄŸustos'},{v:'09',l:'EylÃ¼l'},{v:'10',l:'Ekim'},{v:'11',l:'KasÄ±m'},{v:'12',l:'AralÄ±k'}];
  const currentYear = new Date().getFullYear(); const years = Array.from({ length: 120 }, (_, i) => String(currentYear - 100 + i));
  return (<div><label style={labelStyle}>{label}</label><div style={{ display: 'flex', gap: '4px' }}><select value={day} onChange={e => handleDayChange(e.target.value)} style={{ ...dateSelectStyle, width: '70px' }}><option value="">GÃ¼n</option>{days.map(d => <option key={d} value={d}>{parseInt(d)}</option>)}</select><select value={month} onChange={e => handleMonthChange(e.target.value)} style={{ ...dateSelectStyle, flex: 1 }}><option value="">Ay</option>{months.map(m => <option key={m.v} value={m.v}>{m.l}</option>)}</select><select value={year} onChange={e => handleYearChange(e.target.value)} style={{ ...dateSelectStyle, width: '80px' }}><option value="">YÄ±l</option>{years.map(y => <option key={y} value={y}>{y}</option>)}</select></div></div>);
}

function FileUpload({ label, files, onChange }) {
  const ref = useRef(null); const safeFiles = Array.isArray(files) ? files : [];
  const add = (e) => { const nf = Array.from(e.target.files).map(f => ({ name: f.name, data: URL.createObjectURL(f) })); onChange([...safeFiles, ...nf]); };
  const remove = (index) => { const file = safeFiles[index]; if (file?.data?.startsWith('blob:')) URL.revokeObjectURL(file.data); onChange(safeFiles.filter((_, x) => x !== index)); };
  return (<div><label style={labelStyle}>{label}</label><div style={{ border: '2px dashed rgba(255,255,255,0.2)', borderRadius: '8px', padding: '10px', textAlign: 'center' }}><input ref={ref} type="file" accept="image/*,.pdf" multiple onChange={add} style={{ display: 'none' }} /><button type="button" onClick={() => ref.current?.click()} style={{ background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '6px', padding: '6px 12px', color: '#94a3b8', cursor: 'pointer', fontSize: '12px' }}>ğŸ“ Dosya SeÃ§</button>{safeFiles.length > 0 && <div style={{ marginTop: '6px', display: 'flex', flexWrap: 'wrap', gap: '4px', justifyContent: 'center' }}>{safeFiles.map((f, i) => <div key={i} style={{ background: 'rgba(16,185,129,0.15)', borderRadius: '4px', padding: '2px 6px', fontSize: '10px', display: 'flex', alignItems: 'center', gap: '4px' }}><span style={{ color: '#10b981', maxWidth: '50px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{f.name}</span><button type="button" onClick={() => remove(i)} style={{ background: 'none', border: 'none', color: '#ef4444', cursor: 'pointer', padding: '0', fontSize: '12px' }}>Ã—</button></div>)}</div>}</div></div>);
}

function FormInput({ label, ...p }) { return (<div><label style={labelStyle}>{label}</label><input {...p} style={inputStyle} /></div>); }
function StatCard({ value, label, color }) { return (<div style={{ background: `${color}15`, border: `1px solid ${color}30`, borderRadius: '10px', padding: '14px' }}><div style={{ fontSize: '22px', fontWeight: '700', color }}>{value}</div><div style={{ fontSize: '11px', color: '#94a3b8', marginTop: '2px' }}>{label}</div></div>); }
function Modal({ children, onClose, title }) { return (<div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.85)', backdropFilter: 'blur(5px)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 300, padding: '20px' }}><div style={{ background: 'linear-gradient(180deg, #0f2744 0%, #0c1929 100%)', borderRadius: '12px', width: '100%', maxWidth: '400px', maxHeight: '85vh', overflow: 'auto', border: '1px solid rgba(255,255,255,0.1)' }}><div style={{ padding: '14px 16px', borderBottom: '1px solid rgba(255,255,255,0.1)', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}><h3 style={{ margin: 0, fontSize: '15px', flex: 1 }}>{title}</h3><button onClick={onClose} style={{ background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '6px', width: '28px', height: '28px', cursor: 'pointer', color: '#94a3b8', fontSize: '14px', display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0 }}>âœ•</button></div><div style={{ padding: '14px 16px' }}>{children}</div></div></div>); }
function InfoBox({ label, value, highlight }) { return (<div style={{ background: highlight ? 'rgba(245,158,11,0.1)' : 'rgba(255,255,255,0.03)', borderRadius: '6px', padding: '8px', border: highlight ? '1px solid rgba(245,158,11,0.2)' : 'none' }}><p style={{ fontSize: '10px', color: highlight ? '#f59e0b' : '#64748b', marginBottom: '2px', textTransform: 'uppercase' }}>{label}</p><p style={{ fontSize: '12px', margin: 0, color: value ? (highlight ? '#f59e0b' : '#e8f1f8') : '#64748b' }}>{value || '-'}</p></div>); }
function InfoRow({ label, value }) { return (<div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '12px', padding: '3px 0' }}><span style={{ color: '#94a3b8' }}>{label}:</span><span style={{ color: '#e8f1f8', fontWeight: '500' }}>{value || '-'}</span></div>); }

function LoginScreen({ onLogin, users }) {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  const handleLogin = (e) => {
    e.preventDefault();
    setError('');
    if (!email) { setError('E-posta adresi gerekli'); return; }
    if (!password) { setError('Åifre gerekli'); return; }
    setLoading(true);
    const user = users.find(u => u.email.toLowerCase() === email.toLowerCase() && u.password === password);
    if (user) {
      onLogin(user);
    } else {
      setError('E-posta veya ÅŸifre hatalÄ±');
    }
    setLoading(false);
  };

  return (
    <div style={{ position: 'fixed', inset: 0, display: 'flex', alignItems: 'center', justifyContent: 'center', background: 'linear-gradient(135deg, #0c1929 0%, #1a3a5c 50%, #0d2137 100%)', fontFamily: "'Segoe UI', sans-serif", padding: '20px' }}>
      <div style={{ background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '16px', padding: '40px', width: '100%', maxWidth: '380px' }}>
        <div style={{ textAlign: 'center', marginBottom: '30px' }}>
          <div style={{ fontSize: '48px', marginBottom: '12px' }}>âœˆï¸</div>
          <h1 style={{ margin: 0, fontSize: '24px', color: '#e8f1f8', fontWeight: '700' }}>Paydos Turizm</h1>
          <p style={{ margin: '8px 0 0', fontSize: '13px', color: '#94a3b8' }}>GiriÅŸ yapÄ±n</p>
        </div>
        <form onSubmit={handleLogin}>
          <div style={{ marginBottom: '16px' }}>
            <label style={labelStyle}>E-posta Adresi</label>
            <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} placeholder="ornek@paydos.com" autoComplete="email" style={{ ...inputStyle, padding: '12px 14px', fontSize: '15px' }} />
          </div>
          <div style={{ marginBottom: '20px' }}>
            <label style={labelStyle}>Åifre</label>
            <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" autoComplete="current-password" style={{ ...inputStyle, padding: '12px 14px', fontSize: '15px' }} />
          </div>
          {error && <div style={{ background: 'rgba(239,68,68,0.15)', border: '1px solid rgba(239,68,68,0.3)', borderRadius: '8px', padding: '10px', marginBottom: '16px', fontSize: '12px', color: '#ef4444', textAlign: 'center' }}>{error}</div>}
          <button type="submit" disabled={loading} style={{ width: '100%', padding: '14px', background: loading ? 'rgba(245,158,11,0.5)' : 'linear-gradient(135deg, #f59e0b, #d97706)', border: 'none', borderRadius: '10px', color: '#0c1929', fontWeight: '700', fontSize: '15px', cursor: loading ? 'not-allowed' : 'pointer' }}>
            {loading ? 'GiriÅŸ yapÄ±lÄ±yor...' : 'ğŸ”“ GiriÅŸ Yap'}
          </button>
        </form>
      </div>
    </div>
  );
}

function DashboardModule({ customers, visaApplications, tours, hotelReservations, isMobile, setActiveModule }) {
  const currentYear = new Date().getFullYear(); const currentMonth = new Date().getMonth();
  const totalVisa = visaApplications.length; const approvedVisa = visaApplications.filter(v => v.visaResult === 'Onay').length; const rejectedVisa = visaApplications.filter(v => v.visaResult === 'Red').length; const pendingVisa = totalVisa - approvedVisa - rejectedVisa; const approvalRate = totalVisa > 0 ? Math.round((approvedVisa / totalVisa) * 100) : 0;
  const revenueByEUR = visaApplications.reduce((sum, v) => { if (v.visaFee && v.paymentStatus === 'Ã–dendi' && v.visaFeeCurrency === 'â‚¬') return sum + safeParseNumber(v.visaFee); return sum; }, 0);
  const revenueByTRY = visaApplications.reduce((sum, v) => { if (v.visaFee && v.paymentStatus === 'Ã–dendi' && v.visaFeeCurrency === 'â‚º') return sum + safeParseNumber(v.visaFee); return sum; }, 0);
  const pendingByEUR = visaApplications.reduce((sum, v) => { if (v.visaFee && v.paymentStatus !== 'Ã–dendi' && v.visaFeeCurrency === 'â‚¬') return sum + safeParseNumber(v.visaFee); return sum; }, 0);
  const pendingByTRY = visaApplications.reduce((sum, v) => { if (v.visaFee && v.paymentStatus !== 'Ã–dendi' && v.visaFeeCurrency === 'â‚º') return sum + safeParseNumber(v.visaFee); return sum; }, 0);
  const today = new Date(); today.setHours(0, 0, 0, 0);
  const upcomingAppointments = visaApplications.filter(v => { if (!v.appointmentDate || v.visaResult === 'Onay' || v.visaResult === 'Red') return false; const appDate = safeParseDate(v.appointmentDate); if (!appDate) return false; const diff = Math.ceil((appDate - today) / (1000 * 60 * 60 * 24)); return diff >= 0 && diff <= 10; });
  const reminders = []; const sixMonthsLater = new Date(); sixMonthsLater.setMonth(sixMonthsLater.getMonth() + 6);
  customers.forEach(c => { if (c.passportExpiry) { const expiry = safeParseDate(c.passportExpiry); if (expiry && expiry <= sixMonthsLater && expiry >= today) { const daysLeft = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24)); reminders.push({ type: 'passport', priority: daysLeft <= 30 ? 'high' : daysLeft <= 90 ? 'medium' : 'low', customer: `${c.firstName} ${c.lastName}`, customerId: c.id, message: `Pasaport ${daysLeft} gÃ¼n sonra bitiyor`, date: c.passportExpiry, daysLeft }); } } });
  const oneMonthLater = new Date(); oneMonthLater.setMonth(oneMonthLater.getMonth() + 1);
  customers.forEach(c => { if (c.schengenVisaEnd && c.schengenCountry) { const expiry = safeParseDate(c.schengenVisaEnd); if (expiry && expiry <= oneMonthLater && expiry >= today) { const daysLeft = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24)); reminders.push({ type: 'schengen', priority: daysLeft <= 7 ? 'high' : daysLeft <= 14 ? 'medium' : 'low', customer: `${c.firstName} ${c.lastName}`, customerId: c.id, message: `${c.schengenCountry} Schengen vizesi ${daysLeft} gÃ¼n sonra bitiyor`, date: c.schengenVisaEnd, daysLeft }); } } });
  const threeMonthsLater = new Date(); threeMonthsLater.setMonth(threeMonthsLater.getMonth() + 3);
  customers.forEach(c => { if (c.usaVisaEnd && c.usaVisa === 'Var') { const expiry = safeParseDate(c.usaVisaEnd); if (expiry && expiry <= threeMonthsLater && expiry >= today) { const daysLeft = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24)); reminders.push({ type: 'usa', priority: daysLeft <= 30 ? 'high' : daysLeft <= 60 ? 'medium' : 'low', customer: `${c.firstName} ${c.lastName}`, customerId: c.id, message: `ABD vizesi ${daysLeft} gÃ¼n sonra bitiyor`, date: c.usaVisaEnd, daysLeft }); } } });
  reminders.sort((a, b) => a.daysLeft - b.daysLeft); const priorityColors = { high: '#ef4444', medium: '#f59e0b', low: '#10b981' };
  return (<div style={{ padding: isMobile ? '16px' : '24px' }}><h2 style={{ fontSize: '20px', marginBottom: '20px' }}>ğŸ“Š Dashboard</h2><div style={{ display: 'grid', gridTemplateColumns: isMobile ? 'repeat(2, 1fr)' : 'repeat(4, 1fr)', gap: '12px', marginBottom: '24px' }}><StatCard value={customers.length} label="Toplam MÃ¼ÅŸteri" color="#3b82f6" /><StatCard value={totalVisa} label="Vize BaÅŸvurusu" color="#8b5cf6" /><StatCard value={pendingVisa} label="Bekleyen" color="#f59e0b" /><StatCard value={`%${approvalRate}`} label="Onay OranÄ±" color="#10b981" /></div><div style={{ display: 'grid', gridTemplateColumns: isMobile ? '1fr' : '1fr 1fr', gap: '16px', marginBottom: '24px' }}><div style={{ background: 'rgba(255,255,255,0.03)', borderRadius: '12px', padding: '16px' }}><h3 style={{ fontSize: '14px', marginBottom: '12px', color: '#94a3b8' }}>ğŸ’° Gelir Durumu</h3><div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}><div style={{ background: 'rgba(16,185,129,0.1)', borderRadius: '8px', padding: '10px' }}><p style={{ fontSize: '10px', color: '#10b981', marginBottom: '4px' }}>TAHSÄ°L EDÄ°LEN (EUR)</p><p style={{ fontSize: '18px', fontWeight: '700', color: '#10b981', margin: 0 }}>â‚¬{revenueByEUR.toLocaleString()}</p></div><div style={{ background: 'rgba(16,185,129,0.1)', borderRadius: '8px', padding: '10px' }}><p style={{ fontSize: '10px', color: '#10b981', marginBottom: '4px' }}>TAHSÄ°L EDÄ°LEN (TRY)</p><p style={{ fontSize: '18px', fontWeight: '700', color: '#10b981', margin: 0 }}>â‚º{revenueByTRY.toLocaleString()}</p></div><div style={{ background: 'rgba(245,158,11,0.1)', borderRadius: '8px', padding: '10px' }}><p style={{ fontSize: '10px', color: '#f59e0b', marginBottom: '4px' }}>BEKLEYEN (EUR)</p><p style={{ fontSize: '18px', fontWeight: '700', color: '#f59e0b', margin: 0 }}>â‚¬{pendingByEUR.toLocaleString()}</p></div><div style={{ background: 'rgba(245,158,11,0.1)', borderRadius: '8px', padding: '10px' }}><p style={{ fontSize: '10px', color: '#f59e0b', marginBottom: '4px' }}>BEKLEYEN (TRY)</p><p style={{ fontSize: '18px', fontWeight: '700', color: '#f59e0b', margin: 0 }}>â‚º{pendingByTRY.toLocaleString()}</p></div></div></div><div style={{ background: 'rgba(255,255,255,0.03)', borderRadius: '12px', padding: '16px' }}><h3 style={{ fontSize: '14px', marginBottom: '12px', color: '#94a3b8' }}>ğŸ“… YaklaÅŸan Randevular ({upcomingAppointments.length})</h3>{upcomingAppointments.length === 0 ? (<p style={{ fontSize: '12px', color: '#64748b' }}>YaklaÅŸan randevu yok</p>) : (<div style={{ maxHeight: '150px', overflowY: 'auto' }}>{upcomingAppointments.slice(0, 5).map(v => { const daysLeft = getDaysLeft(v.appointmentDate); return (<div key={v.id} style={{ background: 'rgba(59,130,246,0.1)', borderRadius: '6px', padding: '8px', marginBottom: '6px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}><div><p style={{ fontSize: '12px', fontWeight: '600', margin: 0 }}>{v.customerName}</p><p style={{ fontSize: '10px', color: '#94a3b8', margin: 0 }}>{v.country} - {formatDate(v.appointmentDate)} {v.appointmentTime}</p></div><span style={{ background: daysLeft <= 3 ? '#ef4444' : '#3b82f6', padding: '2px 8px', borderRadius: '10px', fontSize: '10px', fontWeight: '600' }}>{daysLeft} gÃ¼n</span></div>); })}</div>)}</div></div>{reminders.length > 0 && (<div style={{ background: 'rgba(255,255,255,0.03)', borderRadius: '12px', padding: '16px' }}><h3 style={{ fontSize: '14px', marginBottom: '12px', color: '#94a3b8' }}>ğŸ”” HatÄ±rlatmalar ({reminders.length})</h3><div style={{ maxHeight: '200px', overflowY: 'auto' }}>{reminders.slice(0, 10).map((r, i) => (<div key={i} style={{ background: `${priorityColors[r.priority]}15`, borderLeft: `3px solid ${priorityColors[r.priority]}`, borderRadius: '0 6px 6px 0', padding: '8px 12px', marginBottom: '6px' }}><div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}><div><p style={{ fontSize: '12px', fontWeight: '600', margin: 0, color: priorityColors[r.priority] }}>{r.customer}</p><p style={{ fontSize: '11px', color: '#94a3b8', margin: 0 }}>{r.message}</p></div><span style={{ fontSize: '10px', color: '#64748b' }}>{formatDate(r.date)}</span></div></div>))}</div></div>)}</div>);
}

function CustomerModule({ customers, setCustomers, visaApplications, isMobile, onCreateVisa, saveToSupabase }) {
  const [search, setSearch] = useState(''); const [showForm, setShowForm] = useState(false); const [editingCustomer, setEditingCustomer] = useState(null); const [selectedCustomer, setSelectedCustomer] = useState(null); const [formData, setFormData] = useState({}); const [activeTab, setActiveTab] = useState('list'); const [detailTab, setDetailTab] = useState('info'); const [tagInput, setTagInput] = useState(''); const [emailError, setEmailError] = useState('');
  const emptyForm = { tcKimlik: '', firstName: '', lastName: '', gender: '', birthDate: '', birthPlace: '', companyName: '', sector: '', position: '', city: '', phone: '', email: '', address: '', tkMembership: '', passportNo: '', passportStart: '', passportExpiry: '', nationality: 'TÃ¼rkiye', passportDocuments1: [], passportDocuments2: [], greenPassport: 'HayÄ±r', schengenCountry: '', schengenVisaStart: '', schengenVisaEnd: '', schengenDocuments1: [], schengenDocuments2: [], schengenDocuments3: [], schengenDocuments4: [], usaVisa: 'Yok', usaVisaStart: '', usaVisaEnd: '', usaDocuments: [], notes: '', tags: [], activities: [] };
  const resetForm = () => { setFormData(emptyForm); setEditingCustomer(null); setEmailError(''); setTagInput(''); };
  const openNewForm = () => { resetForm(); setShowForm(true); };
  const openEditForm = (customer) => { setEditingCustomer(customer); setFormData({ ...emptyForm, ...customer, tags: safeParseTags(customer.tags), activities: safeParseActivities(customer.activities) }); setShowForm(true); };
  const handleSubmit = async (e) => {
    e.preventDefault(); if (formData.email && !isValidEmail(formData.email)) { setEmailError('GeÃ§erli bir e-posta adresi girin'); return; }
    const now = new Date().toISOString(); const activity = { id: generateUniqueId(), type: editingCustomer ? 'customer_updated' : 'customer_created', description: editingCustomer ? 'MÃ¼ÅŸteri bilgileri gÃ¼ncellendi' : 'MÃ¼ÅŸteri kaydÄ± oluÅŸturuldu', date: now, user: 'Admin' };
    const currentActivities = safeParseActivities(formData.activities); const updatedActivities = [...currentActivities, activity];
    if (editingCustomer) {
      const updated = customers.map(c => c.id === editingCustomer.id ? { ...formData, activities: updatedActivities } : c); setCustomers(updated);
      try { const { error } = await supabase.from('customers').update(toSnakeCase({ ...formData, activities: updatedActivities })).eq('id', editingCustomer.id); if (error) console.error('Supabase update error:', error); } catch (err) { console.error('Update error:', err); }
    } else {
      const newCustomer = { ...formData, id: generateUniqueId(), createdAt: now.split('T')[0], activities: updatedActivities }; setCustomers([...customers, newCustomer]);
      try { const { error } = await supabase.from('customers').insert([toSnakeCase(newCustomer)]); if (error) console.error('Supabase insert error:', error); } catch (err) { console.error('Insert error:', err); }
    }
    setShowForm(false); resetForm();
  };
  const deleteCustomer = async (id) => {
    if (!confirm('Bu mÃ¼ÅŸteriyi silmek istediÄŸinize emin misiniz?')) return;
    setCustomers(customers.filter(c => c.id !== id));
    try { const { error } = await supabase.from('customers').delete().eq('id', id); if (error) console.error('Supabase delete error:', error); } catch (err) { console.error('Delete error:', err); }
    if (selectedCustomer?.id === id) setSelectedCustomer(null);
  };
  const addTag = () => { if (tagInput.trim() && !formData.tags.includes(tagInput.trim())) { setFormData({ ...formData, tags: [...formData.tags, tagInput.trim()] }); setTagInput(''); } };
  const removeTag = (tag) => { setFormData({ ...formData, tags: formData.tags.filter(t => t !== tag) }); };
  const filtered = customers.filter(c => { const searchLower = search.toLowerCase(); return (c.firstName?.toLowerCase().includes(searchLower) || c.lastName?.toLowerCase().includes(searchLower) || c.phone?.includes(search) || c.email?.toLowerCase().includes(searchLower) || c.passportNo?.toLowerCase().includes(searchLower) || c.tcKimlik?.includes(search) || c.companyName?.toLowerCase().includes(searchLower)); });
  const customerVisas = selectedCustomer ? visaApplications.filter(v => v.customerId === selectedCustomer.id) : [];
  const renderForm = () => (<Modal title={editingCustomer ? 'âœï¸ MÃ¼ÅŸteri DÃ¼zenle' : 'â• Yeni MÃ¼ÅŸteri'} onClose={() => { setShowForm(false); resetForm(); }}><form onSubmit={handleSubmit}><div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}><div style={{ background: 'rgba(59,130,246,0.1)', padding: '10px', borderRadius: '8px', marginBottom: '4px' }}><p style={{ fontSize: '11px', color: '#3b82f6', margin: 0, fontWeight: '600' }}>ğŸ‘¤ KÄ°ÅÄ°SEL BÄ°LGÄ°LER</p></div><FormInput label="TC Kimlik No" value={formData.tcKimlik || ''} onChange={e => setFormData({...formData, tcKimlik: e.target.value})} maxLength="11" /><div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}><FormInput label="Ad *" value={formData.firstName || ''} onChange={e => setFormData({...formData, firstName: e.target.value})} required /><FormInput label="Soyad *" value={formData.lastName || ''} onChange={e => setFormData({...formData, lastName: e.target.value})} required /></div><div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}><div><label style={labelStyle}>Cinsiyet</label><select value={formData.gender || ''} onChange={e => setFormData({...formData, gender: e.target.value})} style={selectStyle}><option value="">SeÃ§iniz</option><option value="Erkek">Erkek</option><option value="KadÄ±n">KadÄ±n</option></select></div><div><label style={labelStyle}>DoÄŸum Yeri</label><select value={formData.birthPlace || ''} onChange={e => setFormData({...formData, birthPlace: e.target.value})} style={selectStyle}><option value="">SeÃ§iniz</option>{turkishProvinces.map(p => <option key={p} value={p}>{p}</option>)}</select></div></div><DateInput label="DoÄŸum Tarihi" value={formData.birthDate || ''} onChange={v => setFormData({...formData, birthDate: v})} /><div style={{ background: 'rgba(139,92,246,0.1)', padding: '10px', borderRadius: '8px', marginTop: '8px', marginBottom: '4px' }}><p style={{ fontSize: '11px', color: '#8b5cf6', margin: 0, fontWeight: '600' }}>ğŸ¢ FÄ°RMA BÄ°LGÄ°LERÄ°</p></div><FormInput label="Firma AdÄ±" value={formData.companyName || ''} onChange={e => setFormData({...formData, companyName: e.target.value})} /><div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}><FormInput label="SektÃ¶r" value={formData.sector || ''} onChange={e => setFormData({...formData, sector: e.target.value})} /><FormInput label="Pozisyon" value={formData.position || ''} onChange={e => setFormData({...formData, position: e.target.value})} /></div><div style={{ background: 'rgba(16,185,129,0.1)', padding: '10px', borderRadius: '8px', marginTop: '8px', marginBottom: '4px' }}><p style={{ fontSize: '11px', color: '#10b981', margin: 0, fontWeight: '600' }}>ğŸ“ Ä°LETÄ°ÅÄ°M BÄ°LGÄ°LERÄ°</p></div><div><label style={labelStyle}>Åehir</label><select value={formData.city || ''} onChange={e => setFormData({...formData, city: e.target.value})} style={selectStyle}><option value="">SeÃ§iniz</option>{turkishProvinces.map(p => <option key={p} value={p}>{p}</option>)}</select></div><FormInput label="Telefon *" type="tel" value={formData.phone || ''} onChange={e => setFormData({...formData, phone: e.target.value})} required /><div><FormInput label="E-posta" type="email" value={formData.email || ''} onChange={e => { setFormData({...formData, email: e.target.value}); setEmailError(''); }} />{emailError && <p style={{ color: '#ef4444', fontSize: '11px', marginTop: '4px' }}>{emailError}</p>}</div><FormInput label="Adres" value={formData.address || ''} onChange={e => setFormData({...formData, address: e.target.value})} /><FormInput label="TK Miles&Smiles" value={formData.tkMembership || ''} onChange={e => setFormData({...formData, tkMembership: e.target.value})} /><div style={{ background: 'rgba(245,158,11,0.1)', padding: '10px', borderRadius: '8px', marginTop: '8px', marginBottom: '4px' }}><p style={{ fontSize: '11px', color: '#f59e0b', margin: 0, fontWeight: '600' }}>ğŸ›‚ PASAPORT BÄ°LGÄ°LERÄ°</p></div><FormInput label="Pasaport No" value={formData.passportNo || ''} onChange={e => setFormData({...formData, passportNo: e.target.value})} /><div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}><DateInput label="VeriliÅŸ Tarihi" value={formData.passportStart || ''} onChange={v => setFormData({...formData, passportStart: v})} /><DateInput label="BitiÅŸ Tarihi" value={formData.passportExpiry || ''} onChange={v => setFormData({...formData, passportExpiry: v})} /></div><div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}><div><label style={labelStyle}>Uyruk</label><select value={formData.nationality || 'TÃ¼rkiye'} onChange={e => setFormData({...formData, nationality: e.target.value})} style={selectStyle}><option value="TÃ¼rkiye">TÃ¼rkiye</option><option value="KKTC">KKTC</option><option value="DiÄŸer">DiÄŸer</option></select></div><div><label style={labelStyle}>YeÅŸil Pasaport</label><select value={formData.greenPassport || 'HayÄ±r'} onChange={e => setFormData({...formData, greenPassport: e.target.value})} style={selectStyle}><option value="HayÄ±r">HayÄ±r</option><option value="Evet">Evet</option></select></div></div><FileUpload label="Pasaport Ã–n YÃ¼z" files={formData.passportDocuments1} onChange={f => setFormData({...formData, passportDocuments1: f})} /><FileUpload label="Pasaport Arka YÃ¼z" files={formData.passportDocuments2} onChange={f => setFormData({...formData, passportDocuments2: f})} /><div style={{ background: 'rgba(59,130,246,0.1)', padding: '10px', borderRadius: '8px', marginTop: '8px', marginBottom: '4px' }}><p style={{ fontSize: '11px', color: '#3b82f6', margin: 0, fontWeight: '600' }}>ğŸ‡ªğŸ‡º SCHENGEN VÄ°ZESÄ°</p></div><div><label style={labelStyle}>Schengen Ãœlkesi</label><select value={formData.schengenCountry || ''} onChange={e => setFormData({...formData, schengenCountry: e.target.value})} style={selectStyle}><option value="">SeÃ§iniz</option>{schengenCountries.map(c => <option key={c} value={c}>{c}</option>)}</select></div><div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}><DateInput label="Vize BaÅŸlangÄ±Ã§" value={formData.schengenVisaStart || ''} onChange={v => setFormData({...formData, schengenVisaStart: v})} /><DateInput label="Vize BitiÅŸ" value={formData.schengenVisaEnd || ''} onChange={v => setFormData({...formData, schengenVisaEnd: v})} /></div><FileUpload label="Vize SayfasÄ±" files={formData.schengenDocuments1} onChange={f => setFormData({...formData, schengenDocuments1: f})} /><div style={{ background: 'rgba(239,68,68,0.1)', padding: '10px', borderRadius: '8px', marginTop: '8px', marginBottom: '4px' }}><p style={{ fontSize: '11px', color: '#ef4444', margin: 0, fontWeight: '600' }}>ğŸ‡ºğŸ‡¸ ABD VÄ°ZESÄ°</p></div><div><label style={labelStyle}>ABD Vizesi</label><select value={formData.usaVisa || 'Yok'} onChange={e => setFormData({...formData, usaVisa: e.target.value})} style={selectStyle}><option value="Yok">Yok</option><option value="Var">Var</option></select></div>{formData.usaVisa === 'Var' && (<><div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}><DateInput label="Vize BaÅŸlangÄ±Ã§" value={formData.usaVisaStart || ''} onChange={v => setFormData({...formData, usaVisaStart: v})} /><DateInput label="Vize BitiÅŸ" value={formData.usaVisaEnd || ''} onChange={v => setFormData({...formData, usaVisaEnd: v})} /></div><FileUpload label="ABD Vize SayfasÄ±" files={formData.usaDocuments} onChange={f => setFormData({...formData, usaDocuments: f})} /></>)}<div style={{ background: 'rgba(168,85,247,0.1)', padding: '10px', borderRadius: '8px', marginTop: '8px', marginBottom: '4px' }}><p style={{ fontSize: '11px', color: '#a855f7', margin: 0, fontWeight: '600' }}>ğŸ·ï¸ ETÄ°KETLER</p></div><div style={{ display: 'flex', gap: '8px' }}><input value={tagInput} onChange={e => setTagInput(e.target.value)} onKeyPress={e => e.key === 'Enter' && (e.preventDefault(), addTag())} placeholder="Etiket ekle..." style={{ ...inputStyle, flex: 1 }} /><button type="button" onClick={addTag} style={{ background: '#a855f7', border: 'none', borderRadius: '8px', padding: '0 16px', color: 'white', cursor: 'pointer' }}>+</button></div>{formData.tags?.length > 0 && (<div style={{ display: 'flex', flexWrap: 'wrap', gap: '6px', marginTop: '8px' }}>{formData.tags.map((tag, i) => (<span key={i} style={{ background: 'rgba(168,85,247,0.2)', color: '#a855f7', padding: '4px 10px', borderRadius: '12px', fontSize: '11px', display: 'flex', alignItems: 'center', gap: '6px' }}>{tag}<button type="button" onClick={() => removeTag(tag)} style={{ background: 'none', border: 'none', color: '#a855f7', cursor: 'pointer', padding: 0 }}>Ã—</button></span>))}</div>)}<div><label style={labelStyle}>Notlar</label><textarea value={formData.notes || ''} onChange={e => setFormData({...formData, notes: e.target.value})} style={{ ...inputStyle, minHeight: '60px', resize: 'vertical' }} /></div><button type="submit" style={{ width: '100%', padding: '14px', background: 'linear-gradient(135deg, #f59e0b, #d97706)', border: 'none', borderRadius: '10px', color: '#0c1929', fontWeight: '700', fontSize: '15px', cursor: 'pointer', marginTop: '8px' }}>{editingCustomer ? 'ğŸ’¾ GÃ¼ncelle' : 'âœ… Kaydet'}</button></div></form></Modal>);
  const renderDetail = () => { if (!selectedCustomer) return null; const c = selectedCustomer; const activities = safeParseActivities(c.activities); const tags = safeParseTags(c.tags); return (<Modal title={`${c.firstName} ${c.lastName}`} onClose={() => setSelectedCustomer(null)}><div style={{ display: 'flex', gap: '6px', marginBottom: '16px', overflowX: 'auto', paddingBottom: '4px' }}>{['info', 'passport', 'visa', 'activity'].map(tab => (<button key={tab} onClick={() => setDetailTab(tab)} style={{ padding: '8px 12px', background: detailTab === tab ? '#f59e0b' : 'rgba(255,255,255,0.05)', border: 'none', borderRadius: '6px', color: detailTab === tab ? '#0c1929' : '#94a3b8', fontSize: '11px', cursor: 'pointer', whiteSpace: 'nowrap', fontWeight: detailTab === tab ? '600' : '400' }}>{{ info: 'ğŸ‘¤ Bilgi', passport: 'ğŸ›‚ Pasaport', visa: 'ğŸŒ Vize', activity: 'ğŸ“‹ Aktivite' }[tab]}</button>))}</div>{detailTab === 'info' && (<div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}><div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}><InfoBox label="TC Kimlik" value={c.tcKimlik} /><InfoBox label="Cinsiyet" value={c.gender} /></div><div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}><InfoBox label="DoÄŸum Tarihi" value={formatDate(c.birthDate)} /><InfoBox label="DoÄŸum Yeri" value={c.birthPlace} /></div><InfoBox label="Firma" value={c.companyName ? `${c.companyName}${c.sector ? ` (${c.sector})` : ''}${c.position ? ` - ${c.position}` : ''}` : '-'} /><div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}><InfoBox label="Telefon" value={c.phone} /><InfoBox label="E-posta" value={c.email} /></div><InfoBox label="Åehir" value={c.city} /><InfoBox label="Adres" value={c.address} /><InfoBox label="TK Miles&Smiles" value={c.tkMembership} />{tags.length > 0 && (<div><p style={{ fontSize: '10px', color: '#64748b', marginBottom: '6px' }}>ETÄ°KETLER</p><div style={{ display: 'flex', flexWrap: 'wrap', gap: '4px' }}>{tags.map((tag, i) => (<span key={i} style={{ background: 'rgba(168,85,247,0.2)', color: '#a855f7', padding: '3px 8px', borderRadius: '10px', fontSize: '10px' }}>{tag}</span>))}</div></div>)}{c.notes && <InfoBox label="Notlar" value={c.notes} />}</div>)}{detailTab === 'passport' && (<div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}><InfoBox label="Pasaport No" value={c.passportNo} highlight /><div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}><InfoBox label="VeriliÅŸ" value={formatDate(c.passportStart)} /><InfoBox label="BitiÅŸ" value={formatDate(c.passportExpiry)} highlight={getDaysLeft(c.passportExpiry) <= 180} /></div><div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}><InfoBox label="Uyruk" value={c.nationality} /><InfoBox label="YeÅŸil Pasaport" value={c.greenPassport} /></div></div>)}{detailTab === 'visa' && (<div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>{c.schengenCountry && (<div style={{ background: 'rgba(59,130,246,0.1)', borderRadius: '8px', padding: '12px' }}><p style={{ fontSize: '11px', color: '#3b82f6', marginBottom: '8px', fontWeight: '600' }}>ğŸ‡ªğŸ‡º SCHENGEN</p><InfoRow label="Ãœlke" value={c.schengenCountry} /><InfoRow label="BaÅŸlangÄ±Ã§" value={formatDate(c.schengenVisaStart)} /><InfoRow label="BitiÅŸ" value={formatDate(c.schengenVisaEnd)} /></div>)}{c.usaVisa === 'Var' && (<div style={{ background: 'rgba(239,68,68,0.1)', borderRadius: '8px', padding: '12px' }}><p style={{ fontSize: '11px', color: '#ef4444', marginBottom: '8px', fontWeight: '600' }}>ğŸ‡ºğŸ‡¸ ABD</p><InfoRow label="BaÅŸlangÄ±Ã§" value={formatDate(c.usaVisaStart)} /><InfoRow label="BitiÅŸ" value={formatDate(c.usaVisaEnd)} /></div>)}{!c.schengenCountry && c.usaVisa !== 'Var' && (<p style={{ fontSize: '12px', color: '#64748b', textAlign: 'center' }}>KayÄ±tlÄ± vize bilgisi yok</p>)}<h4 style={{ fontSize: '13px', color: '#94a3b8', marginTop: '8px' }}>ğŸ“‹ Vize BaÅŸvurularÄ± ({customerVisas.length})</h4>{customerVisas.length === 0 ? (<p style={{ fontSize: '12px', color: '#64748b' }}>HenÃ¼z vize baÅŸvurusu yok</p>) : (customerVisas.map(v => (<div key={v.id} style={{ background: 'rgba(255,255,255,0.03)', borderRadius: '8px', padding: '10px', marginBottom: '6px' }}><div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}><span style={{ fontSize: '12px', fontWeight: '600' }}>{v.country}</span><span style={{ fontSize: '10px', padding: '2px 8px', borderRadius: '10px', background: v.visaResult === 'Onay' ? 'rgba(16,185,129,0.2)' : v.visaResult === 'Red' ? 'rgba(239,68,68,0.2)' : 'rgba(245,158,11,0.2)', color: v.visaResult === 'Onay' ? '#10b981' : v.visaResult === 'Red' ? '#ef4444' : '#f59e0b' }}>{v.status}</span></div><p style={{ fontSize: '10px', color: '#64748b', margin: '4px 0 0' }}>{formatDate(v.applicationDate)}</p></div>)))}<button onClick={() => { setSelectedCustomer(null); onCreateVisa(c); }} style={{ width: '100%', padding: '10px', background: 'rgba(59,130,246,0.2)', border: '1px solid rgba(59,130,246,0.3)', borderRadius: '8px', color: '#3b82f6', fontSize: '12px', cursor: 'pointer', marginTop: '8px' }}>â• Yeni Vize BaÅŸvurusu</button></div>)}{detailTab === 'activity' && (<div style={{ maxHeight: '300px', overflowY: 'auto' }}>{activities.length === 0 ? (<p style={{ fontSize: '12px', color: '#64748b' }}>HenÃ¼z aktivite yok</p>) : (activities.slice().reverse().map((a, i) => (<div key={i} style={{ borderLeft: '2px solid #3b82f6', paddingLeft: '12px', marginBottom: '12px' }}><p style={{ fontSize: '12px', margin: 0 }}>{a.description}</p><p style={{ fontSize: '10px', color: '#64748b', margin: '4px 0 0' }}>{new Date(a.date).toLocaleString('tr-TR')} - {a.user}</p></div>)))}</div>)}<div style={{ display: 'flex', gap: '8px', marginTop: '16px' }}><button onClick={() => { setSelectedCustomer(null); openEditForm(c); }} style={{ flex: 1, padding: '10px', background: 'rgba(59,130,246,0.2)', border: 'none', borderRadius: '8px', color: '#3b82f6', fontSize: '12px', cursor: 'pointer' }}>âœï¸ DÃ¼zenle</button><button onClick={() => deleteCustomer(c.id)} style={{ flex: 1, padding: '10px', background: 'rgba(239,68,68,0.2)', border: 'none', borderRadius: '8px', color: '#ef4444', fontSize: '12px', cursor: 'pointer' }}>ğŸ—‘ï¸ Sil</button></div></Modal>); };
  return (<div style={{ padding: isMobile ? '16px' : '24px' }}><div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px', flexWrap: 'wrap', gap: '12px' }}><h2 style={{ fontSize: '20px', margin: 0 }}>ğŸ‘¥ MÃ¼ÅŸteriler ({customers.length})</h2><button onClick={openNewForm} style={{ background: 'linear-gradient(135deg, #f59e0b, #d97706)', border: 'none', borderRadius: '10px', padding: '10px 20px', color: '#0c1929', fontWeight: '600', cursor: 'pointer', fontSize: '13px' }}>â• Yeni MÃ¼ÅŸteri</button></div><input placeholder="ğŸ” Ad, telefon, e-posta, pasaport no ile ara..." value={search} onChange={e => setSearch(e.target.value)} style={{ ...inputStyle, marginBottom: '16px' }} /><div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>{filtered.length === 0 ? (<p style={{ textAlign: 'center', color: '#64748b', padding: '40px' }}>MÃ¼ÅŸteri bulunamadÄ±</p>) : (filtered.map(c => { const tags = safeParseTags(c.tags); return (<div key={c.id} onClick={() => setSelectedCustomer(c)} style={{ background: 'rgba(255,255,255,0.03)', borderRadius: '10px', padding: '14px', cursor: 'pointer', border: '1px solid rgba(255,255,255,0.05)', transition: 'all 0.2s' }}><div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}><div style={{ flex: 1 }}><h3 style={{ margin: 0, fontSize: '15px', fontWeight: '600' }}>{c.firstName} {c.lastName}</h3>{c.companyName && <p style={{ margin: '4px 0 0', fontSize: '12px', color: '#94a3b8' }}>{c.companyName}</p>}<p style={{ margin: '4px 0 0', fontSize: '12px', color: '#64748b' }}>{c.phone}</p></div><div style={{ display: 'flex', flexDirection: 'column', alignItems: 'flex-end', gap: '4px' }}>{c.schengenCountry && (<span style={{ fontSize: '10px', padding: '2px 8px', borderRadius: '10px', background: 'rgba(59,130,246,0.2)', color: '#3b82f6' }}>ğŸ‡ªğŸ‡º {c.schengenCountry}</span>)}{c.usaVisa === 'Var' && (<span style={{ fontSize: '10px', padding: '2px 8px', borderRadius: '10px', background: 'rgba(239,68,68,0.2)', color: '#ef4444' }}>ğŸ‡ºğŸ‡¸ ABD</span>)}</div></div>{tags.length > 0 && (<div style={{ display: 'flex', flexWrap: 'wrap', gap: '4px', marginTop: '8px' }}>{tags.slice(0, 3).map((tag, i) => (<span key={i} style={{ background: 'rgba(168,85,247,0.15)', color: '#a855f7', padding: '2px 8px', borderRadius: '10px', fontSize: '10px' }}>{tag}</span>))}{tags.length > 3 && <span style={{ fontSize: '10px', color: '#64748b' }}>+{tags.length - 3}</span>}</div>)}</div>); }))}</div>{showForm && renderForm()}{selectedCustomer && renderDetail()}</div>);
}

function VisaModule({ customers, visaApplications, setVisaApplications, isMobile, preselectedCustomer, clearPreselectedCustomer, saveToSupabase }) {
  const [search, setSearch] = useState(''); const [showForm, setShowForm] = useState(false); const [editingVisa, setEditingVisa] = useState(null); const [selectedVisa, setSelectedVisa] = useState(null); const [formData, setFormData] = useState({}); const [statusFilter, setStatusFilter] = useState('all'); const [detailTab, setDetailTab] = useState('info');
  const emptyForm = { customerId: '', customerName: '', visaCategory: 'schengen', country: '', purposeType: 'tourist', usaVisaType: '', usaConsulate: '', ukVisaType: '', ukVisaDuration: '', ukConsulate: '', russiaVisaType: '', uaeVisaType: '', passportValidityOk: '', passportHasPages: '', passportConditionOk: '', passportCheckDone: false, islem: 'Paydos', status: 'Evrak Topluyor', applicationDate: new Date().toISOString().split('T')[0], appointmentDate: '', appointmentTime: '', appointmentPnr: '', visaResult: '', visaDuration: '', visaDurationType: 'gÃ¼n', visaStartDate: '', visaEndDate: '', visaFee: '', visaFeeCurrency: 'â‚¬', paymentStatus: 'Ã–denmedi', notes: '' };
  useEffect(() => { if (preselectedCustomer && !showForm) { setFormData({ ...emptyForm, customerId: preselectedCustomer.id, customerName: `${preselectedCustomer.firstName} ${preselectedCustomer.lastName}` }); setShowForm(true); } }, [preselectedCustomer]);
  const resetForm = () => { setFormData(emptyForm); setEditingVisa(null); if (clearPreselectedCustomer) clearPreselectedCustomer(); };
  const openNewForm = () => { resetForm(); setShowForm(true); };
  const openEditForm = (visa) => { setEditingVisa(visa); setFormData({ ...emptyForm, ...visa }); setShowForm(true); };
  const handleSubmit = async (e) => {
    e.preventDefault();
    if (editingVisa) {
      const updated = visaApplications.map(v => v.id === editingVisa.id ? { ...formData } : v); setVisaApplications(updated);
      try { const { error } = await supabase.from('visa_applications').update(toSnakeCase(formData)).eq('id', editingVisa.id); if (error) console.error('Supabase update error:', error); } catch (err) { console.error('Update error:', err); }
    } else {
      const newVisa = { ...formData, id: generateUniqueId() }; setVisaApplications([...visaApplications, newVisa]);
      try { const { error } = await supabase.from('visa_applications').insert([toSnakeCase(newVisa)]); if (error) console.error('Supabase insert error:', error); } catch (err) { console.error('Insert error:', err); }
    }
    setShowForm(false); resetForm();
  };
  const deleteVisa = async (id) => {
    if (!confirm('Bu vize baÅŸvurusunu silmek istediÄŸinize emin misiniz?')) return;
    setVisaApplications(visaApplications.filter(v => v.id !== id));
    try { const { error } = await supabase.from('visa_applications').delete().eq('id', id); if (error) console.error('Supabase delete error:', error); } catch (err) { console.error('Delete error:', err); }
    if (selectedVisa?.id === id) setSelectedVisa(null);
  };
  const filtered = visaApplications.filter(v => { const searchLower = search.toLowerCase(); const matchSearch = v.customerName?.toLowerCase().includes(searchLower) || v.country?.toLowerCase().includes(searchLower); const matchStatus = statusFilter === 'all' || v.status === statusFilter; return matchSearch && matchStatus; });
  const getStatusColor = (status) => { const colors = { 'Evrak Topluyor': '#f59e0b', 'Evrak TamamlandÄ±': '#3b82f6', 'Evraklar GÃ¶nderildi': '#8b5cf6', 'E-posta GÃ¶nderildi': '#06b6d4', 'Randevu Bekliyor': '#ec4899', 'BaÅŸvuru YapÄ±ldÄ±': '#6366f1', 'SonuÃ§ Bekliyor': '#14b8a6', 'MÃ¼ÅŸteri Ä°ptal Etti': '#64748b' }; return colors[status] || '#94a3b8'; };
  const getResultColor = (result) => { if (result === 'Onay') return '#10b981'; if (result === 'Red') return '#ef4444'; return '#f59e0b'; };
  const getCategoryLabel = (cat) => { const labels = { schengen: 'ğŸ‡ªğŸ‡º Schengen', usa: 'ğŸ‡ºğŸ‡¸ ABD', uk: 'ğŸ‡¬ğŸ‡§ Ä°ngiltere', russia: 'ğŸ‡·ğŸ‡º Rusya', uae: 'ğŸ‡¦ğŸ‡ª BAE', other: 'ğŸŒ DiÄŸer' }; return labels[cat] || cat; };
  const visaCategories = [{ value: 'schengen', label: 'ğŸ‡ªğŸ‡º Schengen' }, { value: 'usa', label: 'ğŸ‡ºğŸ‡¸ ABD' }, { value: 'uk', label: 'ğŸ‡¬ğŸ‡§ Ä°ngiltere' }, { value: 'russia', label: 'ğŸ‡·ğŸ‡º Rusya' }, { value: 'uae', label: 'ğŸ‡¦ğŸ‡ª BAE' }, { value: 'other', label: 'ğŸŒ DiÄŸer' }];
  const purposeTypes = [{ value: 'tourist', label: 'Turistik' }, { value: 'business', label: 'Ticari' }, { value: 'fair', label: 'Fuar' }, { value: 'conference', label: 'Konferans' }, { value: 'medical', label: 'Medikal' }, { value: 'education', label: 'EÄŸitim' }, { value: 'work', label: 'Ã‡alÄ±ÅŸma' }, { value: 'other', label: 'DiÄŸer' }];
  const renderForm = () => (<Modal title={editingVisa ? 'âœï¸ Vize DÃ¼zenle' : 'â• Yeni Vize BaÅŸvurusu'} onClose={() => { setShowForm(false); resetForm(); }}><form onSubmit={handleSubmit}><div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}><div style={{ background: 'rgba(59,130,246,0.1)', padding: '10px', borderRadius: '8px' }}><p style={{ fontSize: '11px', color: '#3b82f6', margin: 0, fontWeight: '600' }}>ğŸ‘¤ MÃœÅTERÄ° SEÃ‡Ä°MÄ°</p></div><div><label style={labelStyle}>MÃ¼ÅŸteri *</label><select value={formData.customerId || ''} onChange={e => { const customer = customers.find(c => c.id == e.target.value); setFormData({ ...formData, customerId: e.target.value, customerName: customer ? `${customer.firstName} ${customer.lastName}` : '' }); }} style={selectStyle} required><option value="">MÃ¼ÅŸteri SeÃ§in</option>{customers.map(c => (<option key={c.id} value={c.id}>{c.firstName} {c.lastName}</option>))}</select></div><div style={{ background: 'rgba(139,92,246,0.1)', padding: '10px', borderRadius: '8px', marginTop: '8px' }}><p style={{ fontSize: '11px', color: '#8b5cf6', margin: 0, fontWeight: '600' }}>ğŸŒ VÄ°ZE BÄ°LGÄ°LERÄ°</p></div><div><label style={labelStyle}>Vize Kategorisi *</label><select value={formData.visaCategory || 'schengen'} onChange={e => setFormData({ ...formData, visaCategory: e.target.value, country: '' })} style={selectStyle}>{visaCategories.map(c => (<option key={c.value} value={c.value}>{c.label}</option>))}</select></div>{formData.visaCategory === 'schengen' && (<div><label style={labelStyle}>Ãœlke *</label><select value={formData.country || ''} onChange={e => setFormData({ ...formData, country: e.target.value })} style={selectStyle} required><option value="">Ãœlke SeÃ§in</option>{schengenCountries.map(c => (<option key={c} value={c}>{c}</option>))}</select></div>)}{formData.visaCategory === 'usa' && (<><div><label style={labelStyle}>Vize TÃ¼rÃ¼</label><select value={formData.usaVisaType || ''} onChange={e => setFormData({ ...formData, usaVisaType: e.target.value, country: 'ABD' })} style={selectStyle}><option value="">SeÃ§in</option><option value="B1/B2">B1/B2 (Turist/Ä°ÅŸ)</option><option value="F1">F1 (Ã–ÄŸrenci)</option><option value="J1">J1 (Exchange)</option><option value="H1B">H1B (Ã‡alÄ±ÅŸma)</option></select></div><div><label style={labelStyle}>Konsolosluk</label><select value={formData.usaConsulate || ''} onChange={e => setFormData({ ...formData, usaConsulate: e.target.value })} style={selectStyle}><option value="">SeÃ§in</option><option value="Ankara">Ankara</option><option value="Ä°stanbul">Ä°stanbul</option></select></div></>)}{formData.visaCategory === 'uk' && (<><div><label style={labelStyle}>Vize TÃ¼rÃ¼</label><select value={formData.ukVisaType || ''} onChange={e => setFormData({ ...formData, ukVisaType: e.target.value, country: 'Ä°ngiltere' })} style={selectStyle}><option value="">SeÃ§in</option><option value="Standard Visitor">Standard Visitor</option><option value="Student">Student</option><option value="Work">Work</option></select></div><div><label style={labelStyle}>SÃ¼re</label><select value={formData.ukVisaDuration || ''} onChange={e => setFormData({ ...formData, ukVisaDuration: e.target.value })} style={selectStyle}><option value="">SeÃ§in</option><option value="6 ay">6 ay</option><option value="2 yÄ±l">2 yÄ±l</option><option value="5 yÄ±l">5 yÄ±l</option><option value="10 yÄ±l">10 yÄ±l</option></select></div></>)}{formData.visaCategory === 'russia' && (<div><label style={labelStyle}>Vize TÃ¼rÃ¼</label><select value={formData.russiaVisaType || ''} onChange={e => setFormData({ ...formData, russiaVisaType: e.target.value, country: 'Rusya' })} style={selectStyle}><option value="">SeÃ§in</option><option value="Turistik">Turistik</option><option value="Ä°ÅŸ">Ä°ÅŸ</option><option value="Ã–zel">Ã–zel</option></select></div>)}{formData.visaCategory === 'uae' && (<div><label style={labelStyle}>Vize TÃ¼rÃ¼</label><select value={formData.uaeVisaType || ''} onChange={e => setFormData({ ...formData, uaeVisaType: e.target.value, country: 'BAE' })} style={selectStyle}><option value="">SeÃ§in</option><option value="30 GÃ¼n">30 GÃ¼n Turist</option><option value="90 GÃ¼n">90 GÃ¼n Turist</option><option value="Transit">Transit</option></select></div>)}{formData.visaCategory === 'other' && (<FormInput label="Ãœlke *" value={formData.country || ''} onChange={e => setFormData({ ...formData, country: e.target.value })} required />)}<div><label style={labelStyle}>Seyahat AmacÄ±</label><select value={formData.purposeType || 'tourist'} onChange={e => setFormData({ ...formData, purposeType: e.target.value })} style={selectStyle}>{purposeTypes.map(p => (<option key={p.value} value={p.value}>{p.label}</option>))}</select></div><div style={{ background: 'rgba(245,158,11,0.1)', padding: '10px', borderRadius: '8px', marginTop: '8px' }}><p style={{ fontSize: '11px', color: '#f59e0b', margin: 0, fontWeight: '600' }}>ğŸ›‚ PASAPORT KONTROLÃœ</p></div><div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '8px' }}><div><label style={labelStyle}>6 Ay GeÃ§erli?</label><select value={formData.passportValidityOk || ''} onChange={e => setFormData({ ...formData, passportValidityOk: e.target.value })} style={selectStyle}><option value="">-</option><option value="Evet">âœ“</option><option value="HayÄ±r">âœ—</option></select></div><div><label style={labelStyle}>BoÅŸ Sayfa?</label><select value={formData.passportHasPages || ''} onChange={e => setFormData({ ...formData, passportHasPages: e.target.value })} style={selectStyle}><option value="">-</option><option value="Evet">âœ“</option><option value="HayÄ±r">âœ—</option></select></div><div><label style={labelStyle}>Kondisyon?</label><select value={formData.passportConditionOk || ''} onChange={e => setFormData({ ...formData, passportConditionOk: e.target.value })} style={selectStyle}><option value="">-</option><option value="Evet">âœ“</option><option value="HayÄ±r">âœ—</option></select></div></div><div style={{ background: 'rgba(16,185,129,0.1)', padding: '10px', borderRadius: '8px', marginTop: '8px' }}><p style={{ fontSize: '11px', color: '#10b981', margin: 0, fontWeight: '600' }}>ğŸ“‹ BAÅVURU DURUMU</p></div><div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}><div><label style={labelStyle}>Ä°ÅŸlem</label><select value={formData.islem || 'Paydos'} onChange={e => setFormData({ ...formData, islem: e.target.value })} style={selectStyle}><option value="Paydos">Paydos</option><option value="MÃ¼ÅŸteri">MÃ¼ÅŸteri Kendisi</option></select></div><div><label style={labelStyle}>Durum *</label><select value={formData.status || 'Evrak Topluyor'} onChange={e => setFormData({ ...formData, status: e.target.value })} style={selectStyle}>{visaStatuses.map(s => (<option key={s} value={s}>{s}</option>))}</select></div></div><DateInput label="BaÅŸvuru Tarihi" value={formData.applicationDate || ''} onChange={v => setFormData({ ...formData, applicationDate: v })} /><div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}><DateInput label="Randevu Tarihi" value={formData.appointmentDate || ''} onChange={v => setFormData({ ...formData, appointmentDate: v })} /><FormInput label="Randevu Saati" type="time" value={formData.appointmentTime || ''} onChange={e => setFormData({ ...formData, appointmentTime: e.target.value })} /></div><FormInput label="Randevu PNR" value={formData.appointmentPnr || ''} onChange={e => setFormData({ ...formData, appointmentPnr: e.target.value })} /><div style={{ background: 'rgba(239,68,68,0.1)', padding: '10px', borderRadius: '8px', marginTop: '8px' }}><p style={{ fontSize: '11px', color: '#ef4444', margin: 0, fontWeight: '600' }}>ğŸ¯ SONUÃ‡</p></div><div><label style={labelStyle}>Vize Sonucu</label><select value={formData.visaResult || ''} onChange={e => setFormData({ ...formData, visaResult: e.target.value })} style={selectStyle}><option value="">Beklemede</option><option value="Onay">âœ… Onay</option><option value="Red">âŒ Red</option></select></div>{formData.visaResult === 'Onay' && (<><div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr', gap: '8px' }}><FormInput label="Vize SÃ¼resi" type="number" value={formData.visaDuration || ''} onChange={e => setFormData({ ...formData, visaDuration: e.target.value })} /><div><label style={labelStyle}>Birim</label><select value={formData.visaDurationType || 'gÃ¼n'} onChange={e => setFormData({ ...formData, visaDurationType: e.target.value })} style={selectStyle}><option value="gÃ¼n">GÃ¼n</option><option value="ay">Ay</option><option value="yÄ±l">YÄ±l</option></select></div></div><div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}><DateInput label="Vize BaÅŸlangÄ±Ã§" value={formData.visaStartDate || ''} onChange={v => setFormData({ ...formData, visaStartDate: v })} /><DateInput label="Vize BitiÅŸ" value={formData.visaEndDate || ''} onChange={v => setFormData({ ...formData, visaEndDate: v })} /></div></>)}<div style={{ background: 'rgba(168,85,247,0.1)', padding: '10px', borderRadius: '8px', marginTop: '8px' }}><p style={{ fontSize: '11px', color: '#a855f7', margin: 0, fontWeight: '600' }}>ğŸ’° ÃœCRET BÄ°LGÄ°SÄ°</p></div><div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', gap: '8px' }}><FormInput label="Ãœcret" type="number" value={formData.visaFee || ''} onChange={e => setFormData({ ...formData, visaFee: e.target.value })} /><div><label style={labelStyle}>Birim</label><select value={formData.visaFeeCurrency || 'â‚¬'} onChange={e => setFormData({ ...formData, visaFeeCurrency: e.target.value })} style={selectStyle}><option value="â‚¬">â‚¬</option><option value="â‚º">â‚º</option><option value="$">$</option><option value="Â£">Â£</option></select></div><div><label style={labelStyle}>Ã–deme</label><select value={formData.paymentStatus || 'Ã–denmedi'} onChange={e => setFormData({ ...formData, paymentStatus: e.target.value })} style={selectStyle}><option value="Ã–denmedi">Ã–denmedi</option><option value="KÄ±smi">KÄ±smi</option><option value="Ã–dendi">Ã–dendi</option></select></div></div><div><label style={labelStyle}>Notlar</label><textarea value={formData.notes || ''} onChange={e => setFormData({ ...formData, notes: e.target.value })} style={{ ...inputStyle, minHeight: '60px', resize: 'vertical' }} /></div><button type="submit" style={{ width: '100%', padding: '14px', background: 'linear-gradient(135deg, #f59e0b, #d97706)', border: 'none', borderRadius: '10px', color: '#0c1929', fontWeight: '700', fontSize: '15px', cursor: 'pointer', marginTop: '8px' }}>{editingVisa ? 'ğŸ’¾ GÃ¼ncelle' : 'âœ… Kaydet'}</button></div></form></Modal>);
  const renderDetail = () => { if (!selectedVisa) return null; const v = selectedVisa; return (<Modal title={`${v.customerName} - ${v.country}`} onClose={() => setSelectedVisa(null)}><div style={{ display: 'flex', gap: '6px', marginBottom: '16px' }}>{['info', 'dates', 'result'].map(tab => (<button key={tab} onClick={() => setDetailTab(tab)} style={{ padding: '8px 12px', background: detailTab === tab ? '#f59e0b' : 'rgba(255,255,255,0.05)', border: 'none', borderRadius: '6px', color: detailTab === tab ? '#0c1929' : '#94a3b8', fontSize: '11px', cursor: 'pointer', fontWeight: detailTab === tab ? '600' : '400' }}>{{ info: 'ğŸ“‹ Bilgi', dates: 'ğŸ“… Tarihler', result: 'ğŸ¯ SonuÃ§' }[tab]}</button>))}</div>{detailTab === 'info' && (<div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}><InfoBox label="MÃ¼ÅŸteri" value={v.customerName} /><div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}><InfoBox label="Kategori" value={getCategoryLabel(v.visaCategory)} /><InfoBox label="Ãœlke" value={v.country} /></div><InfoBox label="Seyahat AmacÄ±" value={purposeTypes.find(p => p.value === v.purposeType)?.label || v.purposeType} /><div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}><InfoBox label="Ä°ÅŸlem" value={v.islem} /><InfoBox label="Durum" value={v.status} highlight /></div><div style={{ background: 'rgba(245,158,11,0.1)', borderRadius: '8px', padding: '10px', marginTop: '8px' }}><p style={{ fontSize: '11px', color: '#f59e0b', marginBottom: '8px', fontWeight: '600' }}>ğŸ›‚ Pasaport KontrolÃ¼</p><div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '8px' }}><InfoBox label="6 Ay" value={v.passportValidityOk} /><InfoBox label="BoÅŸ Sayfa" value={v.passportHasPages} /><InfoBox label="Kondisyon" value={v.passportConditionOk} /></div></div></div>)}{detailTab === 'dates' && (<div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}><InfoBox label="BaÅŸvuru Tarihi" value={formatDate(v.applicationDate)} />{v.appointmentDate && (<div style={{ background: 'rgba(59,130,246,0.1)', borderRadius: '8px', padding: '12px' }}><p style={{ fontSize: '11px', color: '#3b82f6', marginBottom: '8px', fontWeight: '600' }}>ğŸ“… Randevu</p><InfoRow label="Tarih" value={formatDate(v.appointmentDate)} /><InfoRow label="Saat" value={v.appointmentTime} /><InfoRow label="PNR" value={v.appointmentPnr} /></div>)}{v.visaResult === 'Onay' && v.visaStartDate && (<div style={{ background: 'rgba(16,185,129,0.1)', borderRadius: '8px', padding: '12px' }}><p style={{ fontSize: '11px', color: '#10b981', marginBottom: '8px', fontWeight: '600' }}>âœ… Vize Tarihleri</p><InfoRow label="BaÅŸlangÄ±Ã§" value={formatDate(v.visaStartDate)} /><InfoRow label="BitiÅŸ" value={formatDate(v.visaEndDate)} /><InfoRow label="SÃ¼re" value={`${v.visaDuration} ${v.visaDurationType}`} /></div>)}</div>)}{detailTab === 'result' && (<div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}><div style={{ background: v.visaResult === 'Onay' ? 'rgba(16,185,129,0.1)' : v.visaResult === 'Red' ? 'rgba(239,68,68,0.1)' : 'rgba(245,158,11,0.1)', borderRadius: '12px', padding: '20px', textAlign: 'center' }}><p style={{ fontSize: '32px', margin: '0 0 8px' }}>{v.visaResult === 'Onay' ? 'âœ…' : v.visaResult === 'Red' ? 'âŒ' : 'â³'}</p><p style={{ fontSize: '16px', fontWeight: '700', color: getResultColor(v.visaResult), margin: 0 }}>{v.visaResult || 'Beklemede'}</p></div><div style={{ background: 'rgba(168,85,247,0.1)', borderRadius: '8px', padding: '12px' }}><p style={{ fontSize: '11px', color: '#a855f7', marginBottom: '8px', fontWeight: '600' }}>ğŸ’° Ãœcret</p><InfoRow label="Tutar" value={v.visaFee ? `${v.visaFee} ${v.visaFeeCurrency}` : '-'} /><InfoRow label="Ã–deme Durumu" value={v.paymentStatus} /></div>{v.notes && <InfoBox label="Notlar" value={v.notes} />}</div>)}<div style={{ display: 'flex', gap: '8px', marginTop: '16px' }}><button onClick={() => { setSelectedVisa(null); openEditForm(v); }} style={{ flex: 1, padding: '10px', background: 'rgba(59,130,246,0.2)', border: 'none', borderRadius: '8px', color: '#3b82f6', fontSize: '12px', cursor: 'pointer' }}>âœï¸ DÃ¼zenle</button><button onClick={() => deleteVisa(v.id)} style={{ flex: 1, padding: '10px', background: 'rgba(239,68,68,0.2)', border: 'none', borderRadius: '8px', color: '#ef4444', fontSize: '12px', cursor: 'pointer' }}>ğŸ—‘ï¸ Sil</button></div></Modal>); };
  return (<div style={{ padding: isMobile ? '16px' : '24px' }}><div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px', flexWrap: 'wrap', gap: '12px' }}><h2 style={{ fontSize: '20px', margin: 0 }}>ğŸŒ Vize BaÅŸvurularÄ± ({visaApplications.length})</h2><button onClick={openNewForm} style={{ background: 'linear-gradient(135deg, #f59e0b, #d97706)', border: 'none', borderRadius: '10px', padding: '10px 20px', color: '#0c1929', fontWeight: '600', cursor: 'pointer', fontSize: '13px' }}>â• Yeni BaÅŸvuru</button></div><input placeholder="ğŸ” MÃ¼ÅŸteri adÄ± veya Ã¼lke ile ara..." value={search} onChange={e => setSearch(e.target.value)} style={{ ...inputStyle, marginBottom: '12px' }} /><div style={{ display: 'flex', gap: '6px', marginBottom: '16px', overflowX: 'auto', paddingBottom: '4px' }}><button onClick={() => setStatusFilter('all')} style={{ padding: '6px 12px', background: statusFilter === 'all' ? '#f59e0b' : 'rgba(255,255,255,0.05)', border: 'none', borderRadius: '6px', color: statusFilter === 'all' ? '#0c1929' : '#94a3b8', fontSize: '11px', cursor: 'pointer', whiteSpace: 'nowrap' }}>TÃ¼mÃ¼</button>{visaStatuses.map(s => (<button key={s} onClick={() => setStatusFilter(s)} style={{ padding: '6px 12px', background: statusFilter === s ? getStatusColor(s) : 'rgba(255,255,255,0.05)', border: 'none', borderRadius: '6px', color: statusFilter === s ? '#fff' : '#94a3b8', fontSize: '11px', cursor: 'pointer', whiteSpace: 'nowrap' }}>{s}</button>))}</div><div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>{filtered.length === 0 ? (<p style={{ textAlign: 'center', color: '#64748b', padding: '40px' }}>Vize baÅŸvurusu bulunamadÄ±</p>) : (filtered.map(v => (<div key={v.id} onClick={() => setSelectedVisa(v)} style={{ background: 'rgba(255,255,255,0.03)', borderRadius: '10px', padding: '14px', cursor: 'pointer', border: '1px solid rgba(255,255,255,0.05)' }}><div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}><div><h3 style={{ margin: 0, fontSize: '15px', fontWeight: '600' }}>{v.customerName}</h3><p style={{ margin: '4px 0', fontSize: '13px', color: '#94a3b8' }}>{getCategoryLabel(v.visaCategory)} - {v.country}</p><p style={{ margin: 0, fontSize: '11px', color: '#64748b' }}>{formatDate(v.applicationDate)}</p></div><div style={{ display: 'flex', flexDirection: 'column', alignItems: 'flex-end', gap: '4px' }}><span style={{ fontSize: '10px', padding: '3px 10px', borderRadius: '10px', background: `${getStatusColor(v.status)}20`, color: getStatusColor(v.status), fontWeight: '500' }}>{v.status}</span>{v.visaResult && (<span style={{ fontSize: '10px', padding: '3px 10px', borderRadius: '10px', background: `${getResultColor(v.visaResult)}20`, color: getResultColor(v.visaResult), fontWeight: '600' }}>{v.visaResult === 'Onay' ? 'âœ… Onay' : 'âŒ Red'}</span>)}{v.appointmentDate && !v.visaResult && (<span style={{ fontSize: '10px', color: '#64748b' }}>ğŸ“… {formatDate(v.appointmentDate)}</span>)}</div></div></div>)))}</div>{showForm && renderForm()}{selectedVisa && renderDetail()}</div>);
}

function TourModule({ tours, setTours, isMobile, saveToSupabase }) {
  const [search, setSearch] = useState(''); const [showForm, setShowForm] = useState(false); const [editingTour, setEditingTour] = useState(null); const [formData, setFormData] = useState({});
  const emptyForm = { name: '', destination: '', startDate: '', endDate: '', duration: 0, price: 0, capacity: 0, registered: 0, status: 'Planlama', description: '', notes: '' };
  const resetForm = () => { setFormData(emptyForm); setEditingTour(null); };
  const openNewForm = () => { resetForm(); setShowForm(true); };
  const openEditForm = (tour) => { setEditingTour(tour); setFormData({ ...emptyForm, ...tour }); setShowForm(true); };
  const handleSubmit = async (e) => {
    e.preventDefault();
    if (editingTour) {
      const updated = tours.map(t => t.id === editingTour.id ? { ...formData } : t); setTours(updated);
      try { const { error } = await supabase.from('tours').update(toSnakeCase(formData)).eq('id', editingTour.id); if (error) console.error('Supabase update error:', error); } catch (err) { console.error('Update error:', err); }
    } else {
      const newTour = { ...formData, id: generateUniqueId() }; setTours([...tours, newTour]);
      try { const { error } = await supabase.from('tours').insert([toSnakeCase(newTour)]); if (error) console.error('Supabase insert error:', error); } catch (err) { console.error('Insert error:', err); }
    }
    setShowForm(false); resetForm();
  };
  const deleteTour = async (id) => {
    if (!confirm('Bu turu silmek istediÄŸinize emin misiniz?')) return;
    setTours(tours.filter(t => t.id !== id));
    try { const { error } = await supabase.from('tours').delete().eq('id', id); if (error) console.error('Supabase delete error:', error); } catch (err) { console.error('Delete error:', err); }
  };
  const filtered = tours.filter(t => t.name?.toLowerCase().includes(search.toLowerCase()) || t.destination?.toLowerCase().includes(search.toLowerCase()));
  const getStatusColor = (status) => { const colors = { 'Planlama': '#94a3b8', 'AÃ§Ä±k': '#10b981', 'Dolu': '#f59e0b', 'Devam Ediyor': '#3b82f6', 'TamamlandÄ±': '#8b5cf6', 'Ä°ptal': '#ef4444' }; return colors[status] || '#94a3b8'; };
  const renderForm = () => (<Modal title={editingTour ? 'âœï¸ Tur DÃ¼zenle' : 'â• Yeni Tur'} onClose={() => { setShowForm(false); resetForm(); }}><form onSubmit={handleSubmit}><div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}><FormInput label="Tur AdÄ± *" value={formData.name || ''} onChange={e => setFormData({...formData, name: e.target.value})} required /><FormInput label="Destinasyon *" value={formData.destination || ''} onChange={e => setFormData({...formData, destination: e.target.value})} required /><div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}><DateInput label="BaÅŸlangÄ±Ã§ Tarihi" value={formData.startDate || ''} onChange={v => setFormData({...formData, startDate: v})} /><DateInput label="BitiÅŸ Tarihi" value={formData.endDate || ''} onChange={v => setFormData({...formData, endDate: v})} /></div><div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}><FormInput label="SÃ¼re (GÃ¼n)" type="number" value={formData.duration || ''} onChange={e => setFormData({...formData, duration: parseInt(e.target.value) || 0})} /><FormInput label="Fiyat (â‚º)" type="number" value={formData.price || ''} onChange={e => setFormData({...formData, price: parseInt(e.target.value) || 0})} /></div><div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}><FormInput label="Kapasite" type="number" value={formData.capacity || ''} onChange={e => setFormData({...formData, capacity: parseInt(e.target.value) || 0})} /><FormInput label="KayÄ±tlÄ±" type="number" value={formData.registered || ''} onChange={e => setFormData({...formData, registered: parseInt(e.target.value) || 0})} /></div><div><label style={labelStyle}>Durum</label><select value={formData.status || 'Planlama'} onChange={e => setFormData({...formData, status: e.target.value})} style={selectStyle}>{tourStatuses.map(s => (<option key={s} value={s}>{s}</option>))}</select></div><FormInput label="AÃ§Ä±klama" value={formData.description || ''} onChange={e => setFormData({...formData, description: e.target.value})} /><div><label style={labelStyle}>Notlar</label><textarea value={formData.notes || ''} onChange={e => setFormData({...formData, notes: e.target.value})} style={{ ...inputStyle, minHeight: '60px', resize: 'vertical' }} /></div><button type="submit" style={{ width: '100%', padding: '14px', background: 'linear-gradient(135deg, #f59e0b, #d97706)', border: 'none', borderRadius: '10px', color: '#0c1929', fontWeight: '700', fontSize: '15px', cursor: 'pointer', marginTop: '8px' }}>{editingTour ? 'ğŸ’¾ GÃ¼ncelle' : 'âœ… Kaydet'}</button></div></form></Modal>);
  return (<div style={{ padding: isMobile ? '16px' : '24px' }}><div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px', flexWrap: 'wrap', gap: '12px' }}><h2 style={{ fontSize: '20px', margin: 0 }}>ğŸšŒ Turlar ({tours.length})</h2><button onClick={openNewForm} style={{ background: 'linear-gradient(135deg, #f59e0b, #d97706)', border: 'none', borderRadius: '10px', padding: '10px 20px', color: '#0c1929', fontWeight: '600', cursor: 'pointer', fontSize: '13px' }}>â• Yeni Tur</button></div><input placeholder="ğŸ” Tur adÄ± veya destinasyon ile ara..." value={search} onChange={e => setSearch(e.target.value)} style={{ ...inputStyle, marginBottom: '16px' }} /><div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>{filtered.length === 0 ? (<p style={{ textAlign: 'center', color: '#64748b', padding: '40px' }}>Tur bulunamadÄ±</p>) : (filtered.map(t => (<div key={t.id} style={{ background: 'rgba(255,255,255,0.03)', borderRadius: '10px', padding: '14px', border: '1px solid rgba(255,255,255,0.05)' }}><div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}><div><h3 style={{ margin: 0, fontSize: '15px', fontWeight: '600' }}>{t.name}</h3><p style={{ margin: '4px 0', fontSize: '13px', color: '#94a3b8' }}>ğŸ“ {t.destination}</p><p style={{ margin: 0, fontSize: '11px', color: '#64748b' }}>{formatDate(t.startDate)} - {formatDate(t.endDate)} ({t.duration} gÃ¼n)</p></div><div style={{ display: 'flex', flexDirection: 'column', alignItems: 'flex-end', gap: '4px' }}><span style={{ fontSize: '10px', padding: '3px 10px', borderRadius: '10px', background: `${getStatusColor(t.status)}20`, color: getStatusColor(t.status), fontWeight: '500' }}>{t.status}</span><span style={{ fontSize: '12px', color: '#f59e0b', fontWeight: '600' }}>â‚º{t.price?.toLocaleString()}</span><span style={{ fontSize: '10px', color: '#64748b' }}>{t.registered}/{t.capacity} kiÅŸi</span></div></div><div style={{ display: 'flex', gap: '8px', marginTop: '12px' }}><button onClick={() => openEditForm(t)} style={{ flex: 1, padding: '8px', background: 'rgba(59,130,246,0.2)', border: 'none', borderRadius: '6px', color: '#3b82f6', fontSize: '11px', cursor: 'pointer' }}>âœï¸ DÃ¼zenle</button><button onClick={() => deleteTour(t.id)} style={{ flex: 1, padding: '8px', background: 'rgba(239,68,68,0.2)', border: 'none', borderRadius: '6px', color: '#ef4444', fontSize: '11px', cursor: 'pointer' }}>ğŸ—‘ï¸ Sil</button></div></div>)))}</div>{showForm && renderForm()}</div>);
}

function HotelModule({ customers, hotelReservations, setHotelReservations, isMobile, saveToSupabase }) {
  const [search, setSearch] = useState(''); const [showForm, setShowForm] = useState(false); const [editingReservation, setEditingReservation] = useState(null); const [formData, setFormData] = useState({});
  const emptyForm = { customerId: '', customerName: '', hotelName: '', city: '', checkIn: '', checkOut: '', nights: 1, roomType: 'Standard', adults: 1, children: 0, totalPrice: 0, commission: 0, status: 'Beklemede', confirmationNo: '', notes: '' };
  const resetForm = () => { setFormData(emptyForm); setEditingReservation(null); };
  const openNewForm = () => { resetForm(); setShowForm(true); };
  const openEditForm = (res) => { setEditingReservation(res); setFormData({ ...emptyForm, ...res }); setShowForm(true); };
  const calculateNights = (checkIn, checkOut) => { if (!checkIn || !checkOut) return 0; const start = safeParseDate(checkIn); const end = safeParseDate(checkOut); if (!start || !end) return 0; return Math.ceil((end - start) / (1000 * 60 * 60 * 24)); };
  const handleSubmit = async (e) => {
    e.preventDefault();
    const nights = calculateNights(formData.checkIn, formData.checkOut);
    const dataWithNights = { ...formData, nights };
    if (editingReservation) {
      const updated = hotelReservations.map(r => r.id === editingReservation.id ? dataWithNights : r); setHotelReservations(updated);
      try { const { error } = await supabase.from('hotel_reservations').update(toSnakeCase(dataWithNights)).eq('id', editingReservation.id); if (error) console.error('Supabase update error:', error); } catch (err) { console.error('Update error:', err); }
    } else {
      const newRes = { ...dataWithNights, id: generateUniqueId() }; setHotelReservations([...hotelReservations, newRes]);
      try { const { error } = await supabase.from('hotel_reservations').insert([toSnakeCase(newRes)]); if (error) console.error('Supabase insert error:', error); } catch (err) { console.error('Insert error:', err); }
    }
    setShowForm(false); resetForm();
  };
  const deleteReservation = async (id) => {
    if (!confirm('Bu rezervasyonu silmek istediÄŸinize emin misiniz?')) return;
    setHotelReservations(hotelReservations.filter(r => r.id !== id));
    try { const { error } = await supabase.from('hotel_reservations').delete().eq('id', id); if (error) console.error('Supabase delete error:', error); } catch (err) { console.error('Delete error:', err); }
  };
  const filtered = hotelReservations.filter(r => r.customerName?.toLowerCase().includes(search.toLowerCase()) || r.hotelName?.toLowerCase().includes(search.toLowerCase()));
  const getStatusColor = (status) => { const colors = { 'Beklemede': '#f59e0b', 'OnaylandÄ±': '#10b981', 'Ä°ptal': '#ef4444', 'TamamlandÄ±': '#8b5cf6' }; return colors[status] || '#94a3b8'; };
  const renderForm = () => (<Modal title={editingReservation ? 'âœï¸ Rezervasyon DÃ¼zenle' : 'â• Yeni Rezervasyon'} onClose={() => { setShowForm(false); resetForm(); }}><form onSubmit={handleSubmit}><div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}><div><label style={labelStyle}>MÃ¼ÅŸteri *</label><select value={formData.customerId || ''} onChange={e => { const customer = customers.find(c => c.id == e.target.value); setFormData({ ...formData, customerId: e.target.value, customerName: customer ? `${customer.firstName} ${customer.lastName}` : '' }); }} style={selectStyle} required><option value="">MÃ¼ÅŸteri SeÃ§in</option>{customers.map(c => (<option key={c.id} value={c.id}>{c.firstName} {c.lastName}</option>))}</select></div><FormInput label="Otel AdÄ± *" value={formData.hotelName || ''} onChange={e => setFormData({...formData, hotelName: e.target.value})} required /><div><label style={labelStyle}>Åehir</label><select value={formData.city || ''} onChange={e => setFormData({...formData, city: e.target.value})} style={selectStyle}><option value="">SeÃ§iniz</option>{turkishProvinces.map(p => <option key={p} value={p}>{p}</option>)}</select></div><div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}><DateInput label="GiriÅŸ Tarihi *" value={formData.checkIn || ''} onChange={v => setFormData({...formData, checkIn: v})} /><DateInput label="Ã‡Ä±kÄ±ÅŸ Tarihi *" value={formData.checkOut || ''} onChange={v => setFormData({...formData, checkOut: v})} /></div><div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}><div><label style={labelStyle}>Oda Tipi</label><select value={formData.roomType || 'Standard'} onChange={e => setFormData({...formData, roomType: e.target.value})} style={selectStyle}>{roomTypes.map(r => (<option key={r} value={r}>{r}</option>))}</select></div><div><label style={labelStyle}>Durum</label><select value={formData.status || 'Beklemede'} onChange={e => setFormData({...formData, status: e.target.value})} style={selectStyle}>{hotelStatuses.map(s => (<option key={s} value={s}>{s}</option>))}</select></div></div><div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}><FormInput label="YetiÅŸkin" type="number" min="1" value={formData.adults || 1} onChange={e => setFormData({...formData, adults: parseInt(e.target.value) || 1})} /><FormInput label="Ã‡ocuk" type="number" min="0" value={formData.children || 0} onChange={e => setFormData({...formData, children: parseInt(e.target.value) || 0})} /></div><div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}><FormInput label="Toplam Fiyat (â‚º)" type="number" value={formData.totalPrice || ''} onChange={e => setFormData({...formData, totalPrice: parseFloat(e.target.value) || 0})} /><FormInput label="Komisyon (â‚º)" type="number" value={formData.commission || ''} onChange={e => setFormData({...formData, commission: parseFloat(e.target.value) || 0})} /></div><FormInput label="Onay No" value={formData.confirmationNo || ''} onChange={e => setFormData({...formData, confirmationNo: e.target.value})} /><div><label style={labelStyle}>Notlar</label><textarea value={formData.notes || ''} onChange={e => setFormData({...formData, notes: e.target.value})} style={{ ...inputStyle, minHeight: '60px', resize: 'vertical' }} /></div><button type="submit" style={{ width: '100%', padding: '14px', background: 'linear-gradient(135deg, #f59e0b, #d97706)', border: 'none', borderRadius: '10px', color: '#0c1929', fontWeight: '700', fontSize: '15px', cursor: 'pointer', marginTop: '8px' }}>{editingReservation ? 'ğŸ’¾ GÃ¼ncelle' : 'âœ… Kaydet'}</button></div></form></Modal>);
  return (<div style={{ padding: isMobile ? '16px' : '24px' }}><div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px', flexWrap: 'wrap', gap: '12px' }}><h2 style={{ fontSize: '20px', margin: 0 }}>ğŸ¨ Otel RezervasyonlarÄ± ({hotelReservations.length})</h2><button onClick={openNewForm} style={{ background: 'linear-gradient(135deg, #f59e0b, #d97706)', border: 'none', borderRadius: '10px', padding: '10px 20px', color: '#0c1929', fontWeight: '600', cursor: 'pointer', fontSize: '13px' }}>â• Yeni Rezervasyon</button></div><input placeholder="ğŸ” MÃ¼ÅŸteri veya otel adÄ± ile ara..." value={search} onChange={e => setSearch(e.target.value)} style={{ ...inputStyle, marginBottom: '16px' }} /><div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>{filtered.length === 0 ? (<p style={{ textAlign: 'center', color: '#64748b', padding: '40px' }}>Rezervasyon bulunamadÄ±</p>) : (filtered.map(r => (<div key={r.id} style={{ background: 'rgba(255,255,255,0.03)', borderRadius: '10px', padding: '14px', border: '1px solid rgba(255,255,255,0.05)' }}><div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}><div><h3 style={{ margin: 0, fontSize: '15px', fontWeight: '600' }}>{r.customerName}</h3><p style={{ margin: '4px 0', fontSize: '13px', color: '#94a3b8' }}>ğŸ¨ {r.hotelName} - {r.city}</p><p style={{ margin: 0, fontSize: '11px', color: '#64748b' }}>{formatDate(r.checkIn)} â†’ {formatDate(r.checkOut)} ({r.nights} gece)</p></div><div style={{ display: 'flex', flexDirection: 'column', alignItems: 'flex-end', gap: '4px' }}><span style={{ fontSize: '10px', padding: '3px 10px', borderRadius: '10px', background: `${getStatusColor(r.status)}20`, color: getStatusColor(r.status), fontWeight: '500' }}>{r.status}</span><span style={{ fontSize: '12px', color: '#f59e0b', fontWeight: '600' }}>â‚º{r.totalPrice?.toLocaleString()}</span><span style={{ fontSize: '10px', color: '#64748b' }}>{r.roomType} | {r.adults}Y{r.children > 0 ? `+${r.children}Ã‡` : ''}</span></div></div><div style={{ display: 'flex', gap: '8px', marginTop: '12px' }}><button onClick={() => openEditForm(r)} style={{ flex: 1, padding: '8px', background: 'rgba(59,130,246,0.2)', border: 'none', borderRadius: '6px', color: '#3b82f6', fontSize: '11px', cursor: 'pointer' }}>âœï¸ DÃ¼zenle</button><button onClick={() => deleteReservation(r.id)} style={{ flex: 1, padding: '8px', background: 'rgba(239,68,68,0.2)', border: 'none', borderRadius: '6px', color: '#ef4444', fontSize: '11px', cursor: 'pointer' }}>ğŸ—‘ï¸ Sil</button></div></div>)))}</div>{showForm && renderForm()}</div>);
}

export default function App() {
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [currentUser, setCurrentUser] = useState(null);
  const [activeModule, setActiveModule] = useState('dashboard');
  const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
  const [sidebarOpen, setSidebarOpen] = useState(false);
  const [customers, setCustomers] = useState(defaultCustomers);
  const [visaApplications, setVisaApplications] = useState(defaultVisaApplications);
  const [tours, setTours] = useState(defaultTours);
  const [hotelReservations, setHotelReservations] = useState(defaultHotelReservations);
  const [users, setUsers] = useState(defaultUsers);
  const [preselectedCustomer, setPreselectedCustomer] = useState(null);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    const handleResize = () => setIsMobile(window.innerWidth < 768);
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  useEffect(() => {
    const loggedIn = localStorage.getItem('paydos_logged_in');
    const savedUser = localStorage.getItem('paydos_current_user');
    if (loggedIn === 'true' && savedUser) {
      try { setCurrentUser(JSON.parse(savedUser)); setIsLoggedIn(true); } catch (e) { console.error('User parse error:', e); }
    }
  }, []);

  useEffect(() => { loadDataFromSupabase(); }, []);

  const loadDataFromSupabase = async () => {
    setIsLoading(true);
    try {
      const { data: customersData, error: customersError } = await supabase.from('customers').select('*').order('created_at', { ascending: false });
      if (customersError) console.error('Customers error:', customersError);
      else if (customersData && customersData.length > 0) setCustomers(customersData.map(c => ({ ...toCamelCase(c), tags: safeParseTags(c.tags), activities: safeParseActivities(c.activities) })));
      const { data: visaData, error: visaError } = await supabase.from('visa_applications').select('*').order('application_date', { ascending: false });
      if (visaError) console.error('Visa error:', visaError);
      else if (visaData && visaData.length > 0) setVisaApplications(visaData.map(toCamelCase));
      const { data: toursData, error: toursError } = await supabase.from('tours').select('*').order('start_date', { ascending: false });
      if (toursError) console.error('Tours error:', toursError);
      else if (toursData && toursData.length > 0) setTours(toursData.map(toCamelCase));
      const { data: hotelData, error: hotelError } = await supabase.from('hotel_reservations').select('*').order('check_in', { ascending: false });
      if (hotelError) console.error('Hotel error:', hotelError);
      else if (hotelData && hotelData.length > 0) setHotelReservations(hotelData.map(toCamelCase));
      const { data: usersData, error: usersError } = await supabase.from('users').select('*');
      if (usersError) console.error('Users error:', usersError);
      else if (usersData && usersData.length > 0) setUsers(usersData.map(toCamelCase));
    } catch (err) { console.error('Load error:', err); }
    setIsLoading(false);
  };

  const handleLogin = (user) => {
    setIsLoggedIn(true);
    setCurrentUser(user);
    localStorage.setItem('paydos_logged_in', 'true');
    localStorage.setItem('paydos_current_user', JSON.stringify(user));
  };

  const handleLogout = () => {
    setIsLoggedIn(false);
    setCurrentUser(null);
    localStorage.removeItem('paydos_logged_in');
    localStorage.removeItem('paydos_current_user');
  };

  const handleCreateVisa = (customer) => { setPreselectedCustomer(customer); setActiveModule('visa'); };
  const clearPreselectedCustomer = () => setPreselectedCustomer(null);

  if (!isLoggedIn) return <LoginScreen onLogin={handleLogin} users={users} />;

  if (isLoading) return (<div style={{ position: 'fixed', inset: 0, display: 'flex', alignItems: 'center', justifyContent: 'center', background: 'linear-gradient(135deg, #0c1929 0%, #1a3a5c 50%, #0d2137 100%)', fontFamily: "'Segoe UI', sans-serif" }}><div style={{ textAlign: 'center' }}><div style={{ fontSize: '48px', marginBottom: '16px' }}>âœˆï¸</div><p style={{ color: '#94a3b8' }}>YÃ¼kleniyor...</p></div></div>);

  const menuItems = [
    { id: 'dashboard', icon: 'ğŸ“Š', label: 'Dashboard' },
    { id: 'customers', icon: 'ğŸ‘¥', label: 'MÃ¼ÅŸteriler' },
    { id: 'visa', icon: 'ğŸŒ', label: 'Vize' },
    { id: 'tours', icon: 'ğŸšŒ', label: 'Turlar' },
    { id: 'hotels', icon: 'ğŸ¨', label: 'Oteller' }
  ];

  const renderModule = () => {
    switch (activeModule) {
      case 'dashboard': return <DashboardModule customers={customers} visaApplications={visaApplications} tours={tours} hotelReservations={hotelReservations} isMobile={isMobile} setActiveModule={setActiveModule} />;
      case 'customers': return <CustomerModule customers={customers} setCustomers={setCustomers} visaApplications={visaApplications} isMobile={isMobile} onCreateVisa={handleCreateVisa} />;
      case 'visa': return <VisaModule customers={customers} visaApplications={visaApplications} setVisaApplications={setVisaApplications} isMobile={isMobile} preselectedCustomer={preselectedCustomer} clearPreselectedCustomer={clearPreselectedCustomer} />;
      case 'tours': return <TourModule tours={tours} setTours={setTours} isMobile={isMobile} />;
      case 'hotels': return <HotelModule customers={customers} hotelReservations={hotelReservations} setHotelReservations={setHotelReservations} isMobile={isMobile} />;
      default: return <DashboardModule customers={customers} visaApplications={visaApplications} tours={tours} hotelReservations={hotelReservations} isMobile={isMobile} setActiveModule={setActiveModule} />;
    }
  };

  return (
    <div style={{ minHeight: '100vh', background: 'linear-gradient(135deg, #0c1929 0%, #1a3a5c 50%, #0d2137 100%)', color: '#e8f1f8', fontFamily: "'Segoe UI', system-ui, sans-serif" }}>
      {isMobile && sidebarOpen && (<div onClick={() => setSidebarOpen(false)} style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', zIndex: 100 }} />)}
      <aside style={{ position: 'fixed', left: isMobile ? (sidebarOpen ? 0 : '-280px') : 0, top: 0, bottom: 0, width: '260px', background: 'rgba(0,0,0,0.3)', backdropFilter: 'blur(10px)', borderRight: '1px solid rgba(255,255,255,0.1)', zIndex: 200, transition: 'left 0.3s ease', display: 'flex', flexDirection: 'column' }}>
        <div style={{ padding: '20px', borderBottom: '1px solid rgba(255,255,255,0.1)' }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
            <span style={{ fontSize: '32px' }}>âœˆï¸</span>
            <div><h1 style={{ margin: 0, fontSize: '18px', fontWeight: '700' }}>Paydos</h1><p style={{ margin: 0, fontSize: '11px', color: '#94a3b8' }}>Turizm CRM</p></div>
          </div>
        </div>
        <nav style={{ flex: 1, padding: '16px 12px' }}>
          {menuItems.map(item => (<button key={item.id} onClick={() => { setActiveModule(item.id); if (isMobile) setSidebarOpen(false); }} style={{ width: '100%', display: 'flex', alignItems: 'center', gap: '12px', padding: '12px 16px', marginBottom: '4px', background: activeModule === item.id ? 'rgba(245,158,11,0.15)' : 'transparent', border: activeModule === item.id ? '1px solid rgba(245,158,11,0.3)' : '1px solid transparent', borderRadius: '10px', color: activeModule === item.id ? '#f59e0b' : '#94a3b8', cursor: 'pointer', fontSize: '14px', fontWeight: activeModule === item.id ? '600' : '400', transition: 'all 0.2s' }}><span style={{ fontSize: '18px' }}>{item.icon}</span>{item.label}</button>))}
        </nav>
        <div style={{ padding: '16px', borderTop: '1px solid rgba(255,255,255,0.1)' }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '12px' }}>
            <div style={{ width: '36px', height: '36px', borderRadius: '50%', background: 'linear-gradient(135deg, #f59e0b, #d97706)', display: 'flex', alignItems: 'center', justifyContent: 'center', fontWeight: '700', fontSize: '14px' }}>{currentUser?.name?.[0] || 'U'}</div>
            <div><p style={{ margin: 0, fontSize: '13px', fontWeight: '600' }}>{currentUser?.name}</p><p style={{ margin: 0, fontSize: '10px', color: '#64748b' }}>{currentUser?.role === 'admin' ? 'YÃ¶netici' : 'KullanÄ±cÄ±'}</p></div>
          </div>
          <button onClick={handleLogout} style={{ width: '100%', padding: '10px', background: 'rgba(239,68,68,0.1)', border: '1px solid rgba(239,68,68,0.2)', borderRadius: '8px', color: '#ef4444', cursor: 'pointer', fontSize: '12px' }}>ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</button>
        </div>
      </aside>
      <main style={{ marginLeft: isMobile ? 0 : '260px', minHeight: '100vh' }}>
        {isMobile && (<header style={{ position: 'sticky', top: 0, background: 'rgba(12,25,41,0.95)', backdropFilter: 'blur(10px)', borderBottom: '1px solid rgba(255,255,255,0.1)', padding: '12px 16px', display: 'flex', alignItems: 'center', justifyContent: 'space-between', zIndex: 50 }}><button onClick={() => setSidebarOpen(true)} style={{ background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '8px', padding: '8px 12px', color: '#e8f1f8', cursor: 'pointer', fontSize: '18px' }}>â˜°</button><div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}><span style={{ fontSize: '24px' }}>âœˆï¸</span><span style={{ fontWeight: '700' }}>Paydos</span></div><div style={{ width: '40px' }} /></header>)}
        {renderModule()}
      </main>
    </div>
  );
}
